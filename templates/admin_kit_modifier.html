<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Modifier le Kit : {{ kit.nom }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/script.js') }}" defer></script>
</head>
<body>
    {% include 'header.html' %}
    <div class="main-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
            {% for category, message in messages %}
                <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
            </div>
        {% endif %}
        {% endwith %}

        <nav class="breadcrumb-nav">
            <a href="{{ url_for('admin.gestion_kits') }}" class="breadcrumb-link">
                <span class="breadcrumb-icon">
                    <svg class="page-title-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M280-80q-33 0-56.5-23.5T200-160v-480q0-33 23.5-56.5T280-720h400q33 0 56.5 23.5T760-640v480q0 33-23.5 56.5T680-80H280Zm0-80h400v-480H280v480Zm100-40q17 0 28.5-11.5T420-240q0-17-11.5-28.5T380-280q-17 0-28.5 11.5T340-240q0 17 11.5 28.5T380-200Zm200 0q17 0 28.5-11.5T620-240q0-17-11.5-28.5T580-280q-17 0-28.5 11.5T540-240q0 17 11.5 28.5T580-200ZM480-320q50 0 85-35t35-85q0-50-35-85t-85-35q-50 0-85 35t-35 85q0 50 35 85t85 35ZM280-640v480-480Z"/></svg>
                </span>
                <span class="breadcrumb-text">Gestion des Kits</span>
            </a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-current">{{ kit.nom }}</span>
        </nav>

        <div class="kit-editor-grid">
            <!-- Colonne 1: Objets dans le kit -->
            <div class="details-card">
                <h3 class="management-header">Objets dans le kit "{{ kit.nom }}"</h3>
                {% if objets_in_kit %}
                <form method="post" action="{{ url_for('admin.modifier_kit', kit_id=kit.id) }}">
				<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <table class="objet-table">
                        <thead><tr><th>Nom</th><th>Quantité dans le kit</th><th>Action</th></tr></thead>
                        <tbody>
                        {% for assoc in objets_in_kit %}
							<tr>
								<!-- On accède à l'objet via assoc.objet -->
								<td>{{ assoc.objet.nom }} <span class="text-discret">({{ assoc.objet.quantite_physique }} en stock)</span></td>
								<td><input type="number" name="quantite_{{ assoc.id }}" value="{{ assoc.quantite }}" class="input-small" min="1"></td>
								<td>
									<button type="button" class="btn-action btn-danger btn-open-danger-modal"
											data-action="{{ url_for('admin.retirer_objet_kit', kit_objet_id=assoc.id) }}"
											data-message="Êtes-vous sûr de vouloir retirer '{{ assoc.objet.nom }}' de ce kit ?">
										Retirer
									</button>
								</td>
							</tr>
						{% endfor %}
                        </tbody>
                    </table>
                    <div class="form-actions-right">
                        <button type="submit" class="btn-action">Mettre à jour les quantités</button>
                    </div>
                </form>
                {% else %}
                <p>Ce kit est vide. Ajoutez des objets depuis la liste de droite.</p>
                {% endif %}
            </div>

            <!-- Colonne 2: Objets disponibles -->
            <div class="details-card">
                <h3 class="management-header">Ajouter un objet au kit</h3>
                <input type="text" id="kit-objet-search" placeholder="Rechercher un objet à ajouter..." style="width: 100%; margin-bottom: 15px; padding: 8px;">
                <div class="history-table-container">
                    <table class="objet-table" id="available-objects-table">
                        <thead><tr><th>Nom (Stock)</th><th>Quantité</th><th>Action</th></tr></thead>
                        <tbody>
                        {% for objet in objets_disponibles %}
							<tr>
								<td>{{ objet.nom }} <span class="text-discret">({{ objet.quantite_physique }})</span></td>
								<form method="post" action="{{ url_for('admin.modifier_kit', kit_id=kit.id) }}">
									<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
									<input type="hidden" name="objet_id" value="{{ objet.id }}">
									<td><input type="number" name="quantite" value="1" class="input-small" min="1" max="{{ objet.quantite_physique }}"></td>
									<td><button type="submit" class="btn-action btn-small" {% if objet.quantite_physique == 0 %}disabled{% endif %}>Ajouter</button></td>
								</form>
							</tr>
						{% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% include 'footer.html' %}
	{% include '_modale_danger.html' %}
</body>
</html>