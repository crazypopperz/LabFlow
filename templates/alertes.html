{% extends "base.html" %}
{% block title %}Centre d'Alertes - LabFlow{% endblock %}

{% block content %}
<div class="main-container">
    {% include '_breadcrumb.html' %}
    
    <!-- En-tête avec statistiques -->
    <div class="alerts-header">
        <div class="alerts-title-section">
            <h2 class="page-title h3 mb-0 d-flex align-items-center gap-3">
            <!-- Icône Suggestions (Jaune/Ambre) -->
            <div class="rounded-3 d-flex align-items-center justify-content-center text-white shadow-sm" 
                 style="width: 48px; height: 48px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="28" height="28" fill="currentColor">
                    <path d="M440-280h80v-160h160v-80H520v-160h-80v160H280v80h160v160Zm40 200q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Z"/>
                </svg>
            </div>
            <span class="fw-bold text-dark">Suggestions de Commande</span>
        </h2>
            <p class="alerts-subtitle">Surveillance en temps réel de votre inventaire</p>
        </div>
        
        <div class="alerts-stats">
            <div class="stat-card stat-warning">
                <div class="stat-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="32px">
                        <path d="M640-240v-80h104L536-526 376-366 80-664l56-56 240 240 160-160 264 264v-104h80v240H640Z"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-value">{{ objets_stock|length }}</div>
                    <div class="stat-label">Stock bas</div>
                </div>
            </div>
            
            <div class="stat-card stat-danger">
                <div class="stat-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="32px">
                        <path d="M480-80q-75 0-140.5-28.5t-114-77q-48.5-48.5-77-114T120-440q0-75 28.5-140.5t77-114q48.5-48.5 114-77T480-800q75 0 140.5 28.5t114 77q48.5 48.5 77 114T840-440q0 75-28.5 140.5t-77 114q-48.5 48.5-114 77T480-80Zm0-360Zm112 168 56-56-128-128v-184h-80v216l152 152Z"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-value">{{ objets_peremption|length }}</div>
                    <div class="stat-label">Péremptions</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section Stock Bas -->
    <div class="alert-section" id="suggestions">
        <div class="section-header">
            <div class="section-title-wrapper">
                <svg class="section-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="24px">
                    <path d="M640-240v-80h104L536-526 376-366 80-664l56-56 240 240 160-160 264 264v-104h80v240H640Z"/>
                </svg>
                <h3 class="section-title">Alertes de Stock Bas</h3>
                <span class="section-badge badge-warning">{{ objets_stock|length }}</span>
            </div>
            <p class="section-description">Objets dont la quantité disponible est inférieure au seuil d'alerte</p>
        </div>

        {% if objets_stock %}
        <div class="alerts-grid">
            {% for objet_row in objets_stock %}
            {% set objet = objet_row[0] %}
            {% set quantite_disponible = objet_row[1] %}
            
            <div class="alert-card {{ 'alert-card-resolved' if objet.en_commande }}">
                <!-- Image -->
                <div class="alert-card-image">
                    {% if objet.image_url %}
                    <img src="{{ objet.image_url }}" alt="{{ objet.nom }}">
                    {% else %}
                    <div class="alert-card-image-placeholder">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="48px">
                            <path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm40-80h480L570-480 450-320l-90-120-120 160Zm-40 80v-560 560Z"/>
                        </svg>
                    </div>
                    {% endif %}
                    {% if objet.en_commande %}
                    <div class="alert-resolved-badge">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="18px">
                            <path d="M382-240 154-468l57-57 171 171 367-367 57 57-424 424Z"/>
                        </svg>
                        En commande
                    </div>
                    {% endif %}
                </div>

                <!-- Contenu -->
                <div class="alert-card-content">
                    <h4 class="alert-card-title">
                        <a href="{{ url_for('inventaire.voir_objet', objet_id=objet.id) }}">{{ objet.nom }}</a>
                    </h4>
                    
                    <div class="alert-card-meta">
                        <span class="meta-item">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="16px">
                                <path d="M440-183v-274L200-596v274l240 139Zm80 0 240-139v-274L520-457v274Zm-80 92L160-252q-19-11-29.5-29T120-321v-318q0-22 10.5-40t29.5-29l280-161q19-11 40-11t40 11l280 161q19 11 29.5 29t10.5 40v318q0 22-10.5 40T800-252L520-91q-19 11-40 11t-40-11Z"/>
                            </svg>
                            {{ objet.categorie.nom }}
                        </span>
                        <span class="meta-item">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="16px">
                                <path d="M240-80q-33 0-56.5-23.5T160-160v-400q0-33 23.5-56.5T240-640h40v-80q0-83 58.5-141.5T480-920q83 0 141.5 58.5T680-720v80h40q33 0 56.5 23.5T800-560v400q0 33-23.5 56.5T720-80H240Z"/>
                            </svg>
                            {{ objet.armoire.nom }}
                        </span>
                    </div>

                    <div class="alert-card-metrics">
                        <div class="metric metric-critical">
                            <span class="metric-label">Disponible</span>
                            <span class="metric-value">{{ quantite_disponible }}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Seuil</span>
                            <span class="metric-value">{{ objet.seuil }}</span>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="alert-card-actions">
                    <label class="checkbox-label">
                        <input type="checkbox" class="commande-checkbox" data-id="{{ objet.id }}" {% if objet.en_commande %}checked{% endif %}>
                        <span>Mis en commande</span>
                    </label>
                    <button class="btn-action btn-primary btn-suggest" 
                            data-objet-id="{{ objet.id }}" 
                            data-objet-nom="{{ objet.nom }}"
							data-stock="{{ objet.quantite_physique }}"
							data-seuil="{{ objet.seuil }}">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="18px">
                            <path d="M440-280h80v-160h160v-80H520v-160h-80v160H280v80h160v160Zm40 200q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Z"/>
                        </svg>
                        Suggérer quantité
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-alerts">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="64px">
                <path d="M382-240 154-468l57-57 171 171 367-367 57 57-424 424Z"/>
            </svg>
            <h4>Aucune alerte de stock bas</h4>
            <p>Tous vos articles ont un stock suffisant</p>
        </div>
        {% endif %}
    </div>

    <!-- Section Péremption -->
    <div class="alert-section">
        <div class="section-header">
            <div class="section-title-wrapper">
                <svg class="section-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="24px">
                    <path d="M480-80q-75 0-140.5-28.5t-114-77q-48.5-48.5-77-114T120-440q0-75 28.5-140.5t77-114q48.5-48.5 114-77T480-800q75 0 140.5 28.5t114 77q48.5 48.5 77 114T840-440q0 75-28.5 140.5t-77 114q-48.5 48.5-114 77T480-80Z"/>
                </svg>
                <h3 class="section-title">Alertes de Péremption</h3>
                <span class="section-badge badge-danger">{{ objets_peremption|length }}</span>
            </div>
            <p class="section-description">Produits périmés ou expirant dans les 30 prochains jours</p>
        </div>

        {% if objets_peremption %}
        <div class="alerts-grid">
            {% for objet in objets_peremption %}
            {% set date_peremption_obj = date_actuelle.strptime(objet.date_peremption, '%Y-%m-%d') %}
            {% set jours_restants = (date_peremption_obj - date_actuelle).days %}
            {% set perime = jours_restants < 0 %}
            
            <div class="alert-card {{ 'alert-card-critical' if perime else 'alert-card-warning' }} {{ 'alert-card-resolved' if objet.traite }}">
                <!-- Image -->
                <div class="alert-card-image">
                    {% if objet.image %}
                    <img src="{{ url_for('main.serve_image', filename=objet.image) }}" alt="{{ objet.nom }}">
                    {% else %}
                    <div class="alert-card-image-placeholder">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="48px">
                            <path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Z"/>
                        </svg>
                    </div>
                    {% endif %}
                    {% if objet.traite %}
                    <div class="alert-resolved-badge">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="18px">
                            <path d="M382-240 154-468l57-57 171 171 367-367 57 57-424 424Z"/>
                        </svg>
                        Traité
                    </div>
                    {% endif %}
                </div>

                <!-- Contenu -->
                <div class="alert-card-content">
                    <h4 class="alert-card-title">
                        <a href="{{ url_for('inventaire.voir_objet', objet_id=objet.id) }}">{{ objet.nom }}</a>
                    </h4>
                    
                    <div class="alert-card-meta">
                        <span class="meta-item">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="16px">
                                <path d="M440-183v-274L200-596v274l240 139Zm80 0 240-139v-274L520-457v274Z"/>
                            </svg>
                            {{ objet.categorie.nom }}
                        </span>
                        <span class="meta-item">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="16px">
                                <path d="M240-80q-33 0-56.5-23.5T160-160v-400q0-33 23.5-56.5T240-640h40v-80q0-83 58.5-141.5T480-920q83 0 141.5 58.5T680-720v80h40q33 0 56.5 23.5T800-560v400q0 33-23.5 56.5T720-80H240Z"/>
                            </svg>
                            {{ objet.armoire.nom }}
                        </span>
                    </div>

                    <div class="alert-expiry-info">
                        <div class="expiry-date {{ 'expiry-critical' if perime else 'expiry-warning' }}">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="20px">
                                <path d="M200-80q-33 0-56.5-23.5T120-160v-560q0-33 23.5-56.5T200-800h40v-80h80v80h320v-80h80v80h40q33 0 56.5 23.5T840-720v560q0 33-23.5 56.5T760-80H200Z"/>
                            </svg>
                            {{ date_peremption_obj.strftime('%d/%m/%Y') }}
                        </div>
                        <div class="expiry-status {{ 'status-critical' if perime else 'status-warning' }}">
                            {% if perime %}
                                Périmé depuis {{ jours_restants|abs }} jour{{ 's' if jours_restants|abs > 1 }}
                            {% else %}
                                Expire dans {{ jours_restants }} jour{{ 's' if jours_restants > 1 }}
                            {% endif %}
                        </div>
                    </div>

                    <div class="alert-quantity-badge">
                        {{ objet.quantite_disponible }} unité{{ 's' if objet.quantite_disponible > 1 }}
                    </div>
                </div>

                <!-- Actions -->
                <div class="alert-card-actions">
                    <label class="checkbox-label">
                        <input type="checkbox" class="traite-checkbox" data-id="{{ objet.id }}" {% if objet.traite %}checked{% endif %}>
                        <span>Marquer comme traité</span>
                    </label>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-alerts">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="64px">
                <path d="M382-240 154-468l57-57 171 171 367-367 57 57-424 424Z"/>
            </svg>
            <h4>Aucune alerte de péremption</h4>
            <p>Aucun produit n'expire dans les 30 prochains jours</p>
        </div>
        {% endif %}
    </div>
</div>

{% include '_modale_suggestion.html' %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
{% endblock %}