{% extends "base.html" %}

{% block title %}Centre d'Alertes - LabFlow{% endblock %}

{% block content %}
<div class="main-container">
    
    <!-- Fil d'ariane -->
    {% include '_breadcrumb.html' %}

    <!-- En-tête de page -->
    <div class="d-flex justify-content-between align-items-center mb-5 pb-3 border-bottom">
        <h2 class="h3 mb-0 text-dark d-flex align-items-center gap-3">
            <div class="rounded-3 d-flex align-items-center justify-content-center text-white shadow-sm" 
                 style="width: 48px; height: 48px; background: linear-gradient(135deg, #dc3545 0%, #ff6b6b 100%);">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-exclamation-triangle-fill" viewBox="0 0 16 16">
                    <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/>
                </svg>
            </div>
            <span class="fw-bold">Centre d'Alertes</span>
        </h2>
    </div>

    <!-- ======================================================= -->
    <!-- 1. SECTION SUGGESTIONS (PRIORITAIRE) -->
    <!-- ======================================================= -->
    <div id="suggestions" class="mb-5">
        <div class="d-flex align-items-center gap-2 mb-3">
            <h3 class="h5 fw-bold text-dark mb-0">Suggestions de Commande</h3>
            {% if suggestions %}
            <span class="badge bg-warning text-dark border border-warning-subtle rounded-pill">{{ suggestions|length }}</span>
            {% endif %}
        </div>

        {% if suggestions %}
        <div class="card border-0 shadow-sm rounded-3 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 100px;">Date</th>
                            <th>Objet</th>
                            <th>Demandé par</th>
                            <th class="text-center">Qté</th>
                            <th>Commentaire</th>
                            <th class="text-end" style="width: 120px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in suggestions %}
                        <tr>
                            <td class="text-muted small">{{ s.date_demande.strftime('%d/%m/%Y') }}</td>
                            <td>
                                <a href="{{ url_for('inventaire.voir_objet', objet_id=s.objet_id) }}" class="fw-bold text-decoration-none text-dark">
                                    {{ s.objet.nom }}
                                </a>
                                <div class="small text-muted">Stock actuel : {{ s.objet.quantite_physique }}</div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="rounded-circle bg-light d-flex align-items-center justify-content-center text-secondary border" style="width: 24px; height: 24px;">
                                        <i class="bi bi-person-fill" style="font-size: 0.7rem;"></i>
                                    </div>
                                    <span class="small">{{ s.utilisateur.nom_utilisateur }}</span>
                                </div>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-warning text-dark border border-warning-subtle fs-6">+{{ s.quantite }}</span>
                            </td>
                            <td class="text-muted fst-italic small">{{ s.commentaire or '-' }}</td>
                            <td class="text-end">
                                <div class="d-flex justify-content-end gap-2">
                                    <!-- Valider -->
                                    <button type="button" class="btn btn-sm btn-success" 
                                            title="Valider (Marquer comme traité)"
                                            onclick="window.traiterSuggestion({{ s.id }}, 'valider')">
                                        <i class="bi bi-check-lg"></i>
                                    </button>
                                    
                                    <!-- Refuser -->
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            title="Refuser la suggestion"
                                            onclick="window.traiterSuggestion({{ s.id }}, 'refuser')">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="alert alert-light border text-center py-4 text-muted shadow-sm">
            <i class="bi bi-inbox fs-3 d-block mb-2 opacity-25"></i>
            Aucune suggestion en attente.
        </div>
        {% endif %}
    </div>

    <!-- ======================================================= -->
    <!-- 2. SECTION STOCK CRITIQUE -->
    <!-- ======================================================= -->
    <div class="mb-5">
        <div class="d-flex align-items-center gap-2 mb-3">
            <h3 class="h5 fw-bold text-danger mb-0">Ruptures de Stock & Seuils</h3>
            {% if objets_stock %}
            <span class="badge bg-danger rounded-pill">{{ objets_stock|length }}</span>
            {% endif %}
        </div>

        {% if objets_stock %}
        <div class="row g-3">
            {% for objet in objets_stock %}
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 border-danger border-opacity-25 shadow-sm">
                    <div class="card-body d-flex align-items-center gap-3">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1 fw-bold text-dark">{{ objet.nom }}</h6>
                            <div class="small text-muted mb-2">
                                {{ objet.armoire.nom if objet.armoire else 'Sans armoire' }}
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-danger">Stock: {{ objet.quantite_physique }}</span>
                                <span class="badge bg-light text-dark border">Seuil: {{ objet.seuil }}</span>
                            </div>
                        </div>
                        <a href="{{ url_for('inventaire.voir_objet', objet_id=objet.id) }}" class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-eye"></i>
                        </a>
                    </div>
                    <!-- Barre de progression visuelle -->
                    <div class="progress" style="height: 4px;">
                        {% set percent = (objet.quantite_physique / objet.seuil * 100) if objet.seuil > 0 else 0 %}
                        <div class="progress-bar bg-danger" role="progressbar" style="width: {{ percent }}%"></div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-success border-0 shadow-sm d-flex align-items-center">
            <i class="bi bi-check-circle-fill fs-4 me-3"></i>
            <div>
                <strong>Tout va bien !</strong>
                <div class="small">Aucun objet n'est en dessous de son seuil d'alerte.</div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- ======================================================= -->
    <!-- 3. SECTION PÉREMPTION -->
    <!-- ======================================================= -->
    <div class="mb-5">
        <div class="d-flex align-items-center gap-2 mb-3">
            <h3 class="h5 fw-bold text-warning-emphasis mb-0">Produits Périmés ou Bientôt Périmés</h3>
            {% if objets_peremption %}
            <span class="badge bg-warning text-dark rounded-pill">{{ objets_peremption|length }}</span>
            {% endif %}
        </div>

        {% if objets_peremption %}
        <div class="card border-0 shadow-sm rounded-3 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Objet</th>
                            <th>Date Péremption</th>
                            <th>État</th>
                            <th class="text-end">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for objet in objets_peremption %}
                        <tr>
                            <td class="fw-bold">{{ objet.nom }}</td>
                            <td>{{ objet.date_peremption.strftime('%d/%m/%Y') }}</td>
                            <td>
                                {% if objet.date_peremption < date_actuelle.date() %}
                                    <span class="badge bg-danger">Périmé</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">Bientôt</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <a href="{{ url_for('inventaire.voir_objet', objet_id=objet.id) }}" class="btn btn-sm btn-outline-secondary">
                                    Gérer
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="alert alert-success border-0 shadow-sm d-flex align-items-center">
            <i class="bi bi-check-circle-fill fs-4 me-3"></i>
            <div>
                <strong>Aucun produit périmé.</strong>
                <div class="small">Votre stock est frais et à jour.</div>
            </div>
        </div>
        {% endif %}
    </div>

</div>

<!-- Modale de Confirmation Dynamique -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header text-white" id="modal-header-bg">
                <h5 class="modal-title" id="modal-title">Confirmation</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <p class="mb-0 fs-5" id="modal-message">Voulez-vous vraiment effectuer cette action ?</p>
            </div>
            <div class="modal-footer bg-light border-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn" id="btn-confirm-action">Confirmer</button>
            </div>
        </div>
    </div>
</div>

<!-- SCRIPT CORRIGÉ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentSuggestionId = null;
    let currentAction = null;
    
    // Initialisation de la modale Bootstrap
    const modalElement = document.getElementById('confirmationModal');
    const confirmationModal = new bootstrap.Modal(modalElement);
    
    const confirmBtn = document.getElementById('btn-confirm-action');
    const modalHeader = document.getElementById('modal-header-bg');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');

    // 1. Fonction appelée au clic sur le bouton du tableau
    // On l'attache à window pour qu'elle soit accessible depuis le HTML onclick
    window.traiterSuggestion = function(id, action) {
        currentSuggestionId = id;
        currentAction = action;

        // Configuration visuelle selon l'action
        if (action === 'valider') {
            modalHeader.className = 'modal-header text-white bg-success';
            modalTitle.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Valider la demande';
            modalMessage.textContent = "Voulez-vous valider cette suggestion de commande ?";
            confirmBtn.className = 'btn btn-success';
            confirmBtn.textContent = "Oui, Valider";
        } else {
            modalHeader.className = 'modal-header text-white bg-danger';
            modalTitle.innerHTML = '<i class="bi bi-trash-fill me-2"></i>Refuser la demande';
            modalMessage.textContent = "Voulez-vous refuser et supprimer cette suggestion ?";
            confirmBtn.className = 'btn btn-danger';
            confirmBtn.textContent = "Oui, Refuser";
        }

        confirmationModal.show();
    };

    // 2. Fonction appelée au clic sur "Confirmer" dans la modale
    confirmBtn.addEventListener('click', function() {
        if (!currentSuggestionId || !currentAction) return;

        // État de chargement
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Traitement...';

        fetch(`/api/traiter_suggestion/${currentSuggestionId}/${currentAction}`, {
            method: 'POST',
            headers: {'X-CSRFToken': "{{ csrf_token() }}"}
        }).then(res => {
            if(res.ok) {
                window.location.reload();
            } else {
                alert("Erreur lors du traitement.");
                confirmBtn.disabled = false;
                confirmBtn.textContent = "Réessayer";
            }
        });
    });
});
</script>

{% endblock %}