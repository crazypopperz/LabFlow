{% extends "base.html" %}

{% block title %}Gestion des Kits - LabFlow{% endblock %}

{% block content %}

<div class="main-container">
    {% include '_breadcrumb.html' %}

    <!-- En-tête de page -->
    <div class="management-header mb-4 pb-3 border-bottom d-flex justify-content-between align-items-center flex-wrap gap-3">
        <h2 class="page-title h3 mb-0 d-flex align-items-center gap-3">
            <!-- Icône Kits (Cyan/Rose - ou le style "Valise") -->
            <div class="rounded-3 d-flex align-items-center justify-content-center text-white shadow-sm" 
                 style="width: 48px; height: 48px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="28" height="28" fill="currentColor">
                    <path d="M80-160v-400q0-33 23.5-56.5T160-640h120v-80q0-33 23.5-56.5T360-800h240q33 0 56.5 23.5T680-720v80h120q33 0 56.5 23.5T880-560v400H80Zm240-480h320v-80H320v80Z"/>
                </svg>
            </div>
            <span class="fw-bold text-dark">Gestion des Kits</span>
        </h2>
        
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addKitModal">
            <i class="bi bi-plus-lg me-2"></i> Créer un nouveau kit
        </button>
    </div>

    <!-- Liste des Kits -->
    {% if kits and kits|length > 0 %}
        <div class="card-container management-page">
            {% for item in kits %}
            <div class="kit-card">
                <!-- Icône -->
                <div class="kit-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                        <path d="M80-160v-400q0-33 23.5-56.5T160-640h120v-80q0-33 23.5-56.5T360-800h240q33 0 56.5 23.5T680-720v80h120q33 0 56.5 23.5T880-560v400H80Zm240-480h320v-80H320v80Z"/>
                    </svg>
                </div>

                <!-- Infos -->
                <div class="kit-info">
                    <a href="{{ url_for('admin.modifier_kit', kit_id=item.Kit.id) }}" class="kit-name stretched-link-custom">
                        {{ item.Kit.nom }}
                    </a>
                    <p class="kit-desc">{{ item.Kit.description or 'Aucune description' }}</p>
                    
                    <span class="count-badge">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                            <path d="M440-280h80v-240h-80v240Zm40-320q17 0 28.5-11.5T520-640q0-17-11.5-28.5T480-680q-17 0-28.5 11.5T440-640q0 17 11.5 28.5T480-600Zm0 520q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Z"/>
                        </svg>
                        {% if item.count == 0 %}Vide{% elif item.count == 1 %}1 objet{% else %}{{ item.count }} objets{% endif %}
                    </span>
                </div>

                <!-- Actions -->
                <div class="kit-actions">
                    <!-- Modifier (CRAYON) -->
                    <a href="{{ url_for('admin.modifier_kit', kit_id=item.Kit.id) }}" 
                       class="btn-icon-only btn-edit" 
                       title="Modifier le contenu">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                            <path d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6q16 0 31 6t26 17l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Zm640-584-56-56 56 56Zm-141 85-28-29 57 57-29-28Z"/>
                        </svg>
                    </a>

                    <!-- Supprimer (POUBELLE) -->
                    <button type="button" class="btn-icon-only btn-delete"
                            title="Supprimer le kit"
                            data-bs-toggle="modal"
                            data-bs-target="#deleteKitModal"
                            data-kit-id="{{ item.Kit.id }}"
                            data-kit-name="{{ item.Kit.nom }}">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                            <path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/>
                        </svg>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>

    {% else %}
        <!-- État vide -->
        <div class="text-center py-5 bg-white rounded shadow-sm border">
            <div class="mb-3 text-muted">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 -960 960 960" fill="currentColor" style="opacity: 0.3;">
                    <path d="M80-160v-400q0-33 23.5-56.5T160-640h120v-80q0-33 23.5-56.5T360-800h240q33 0 56.5 23.5T680-720v80h120q33 0 56.5 23.5T880-560v400H80Zm240-480h320v-80H320v80Z"/>
                </svg>
            </div>
            <h3>Aucun kit créé</h3>
            <p class="text-muted">Créez des kits pour regrouper le matériel (ex: TP Chimie, Dissection...).</p>
            <button type="button" class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#addKitModal">
                Créer mon premier kit
            </button>
        </div>
    {% endif %}
</div>

<!-- ================= MODALES ================= -->

<!-- Modale Ajout Kit -->
<div class="modal fade" id="addKitModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-box-seam me-2"></i>Nouveau Kit</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('admin.ajouter_kit') }}" method="post">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label class="form-label">Nom du kit *</label>
                        <input type="text" class="form-control" name="nom" required placeholder="Ex: TP Optique 6ème">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3" placeholder="Détails sur l'usage du kit..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Créer et configurer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modale Suppression Kit -->
<div class="modal fade" id="deleteKitModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Supprimer le kit</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="" method="post" id="deleteKitForm">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="alert alert-danger">
                        Cette action est définitive. Les objets contenus dans le kit ne seront pas supprimés de l'inventaire, mais le regroupement sera perdu.
                    </div>
                    <p class="mb-0">Voulez-vous vraiment supprimer le kit : <strong id="delete-kit-name"></strong> ?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-danger">Supprimer</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion de la modale de suppression
    const deleteModal = document.getElementById('deleteKitModal');
    if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const kitId = button.dataset.kitId;
            const kitName = button.dataset.kitName;
            
            document.getElementById('deleteKitForm').action = `/admin/kits/supprimer/${kitId}`;
            document.getElementById('delete-kit-name').textContent = kitName;
        });
    }
});
</script>
{% endblock %}