{% extends "base.html" %}
{% block title %}Panneau d'Administration - LabFlow{% endblock %}

{% block content %}
<div class="main-container">
    {% include '_breadcrumb.html' %}
    
    <!-- En-tête principal -->
    <div class="admin-hero">
        <div class="admin-hero-content">
            <div class="admin-hero-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="48px">
                    <path d="m370-80-16-128q-13-5-24.5-12T307-235l-119 50L78-375l103-78q-1-7-1-13.5v-27q0-6.5 1-13.5L78-585l110-190 119 50q11-8 23-15t24-12l16-128h220l16 128q13 5 24.5 12t22.5 15l119-50 110 190-103 78q1 7 1 13.5v27q0 6.5-2 13.5l103 78-110 190-118-50q-11 8-23 15t-24 12L590-80H370Z"/>
                </svg>
            </div>
            <div>
                <h1 class="admin-hero-title">Panneau d'Administration</h1>
                <p class="admin-hero-subtitle">Gérez et configurez votre application LabFlow</p>
            </div>
        </div>
		
		<!-- Code d'invitation de l'établissement -->
		<div class="alert alert-info shadow-sm">
			<div class="d-flex align-items-center mb-2">
				<i class="bi bi-ticket-perforated-fill fs-4 me-2"></i>
				<h5 class="mb-0">Code d'invitation de votre établissement</h5>
			</div>
			<p class="mb-2">Partagez ce code avec vos collègues pour qu'ils rejoignent <strong>{{ session.nom_etablissement }}</strong> :</p>
			<div class="input-group">
				<input type="text" 
					   class="form-control form-control-lg text-center fw-bold" 
					   id="codeInvitation"
					   value="{{ etablissement.code_invitation }}" 
					   readonly
					   style="font-family: monospace; font-size: 1.75rem; letter-spacing: 0.1em; background: #f8f9fa;">
				<button class="btn btn-primary btn-lg" onclick="copierCode()" type="button">
					<i class="bi bi-clipboard me-1"></i> Copier
				</button>
			</div>
			<small class="text-muted d-block mt-2">
				<i class="bi bi-info-circle me-1"></i>
				Ce code permet à quiconque le possède de créer un compte dans votre établissement
			</small>
		</div>

		<script>
		function copierCode() {
			const input = document.getElementById('codeInvitation');
			input.select();
			navigator.clipboard.writeText(input.value).then(() => {
				const btn = event.target.closest('button');
				const originalHTML = btn.innerHTML;
				btn.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i> Copié !';
				btn.classList.remove('btn-primary');
				btn.classList.add('btn-success');
				setTimeout(() => {
					btn.innerHTML = originalHTML;
					btn.classList.remove('btn-success');
					btn.classList.add('btn-primary');
				}, 2000);
			});
		}
		</script>
        
        <!-- Statut de la licence -->
        <div class="license-status {{ 'license-pro' if licence.is_pro else 'license-free' }}">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="20px">
                <path d="m354-287 126-76 126 77-33-144 111-96-146-13-58-136-58 135-146 13 111 97-33 143ZM233-120l65-281L80-590l288-25 112-265 112 265 288 25-218 189 65 281-247-149-247 149Zm247-350Z"/>
            </svg>
            <span>{{ 'Version Pro' if licence.is_pro else 'Version Gratuite' }}</span>
        </div>
    </div>

    <!-- Info box -->
    <div class="admin-info-banner">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="24px">
            <path d="M480-680q-33 0-56.5-23.5T400-760q0-33 23.5-56.5T480-840q33 0 56.5 23.5T560-760q0 33-23.5 56.5T480-680Zm-60 560v-480h120v480H420Z"/>
        </svg>
        <p>Cette section vous permet d'effectuer des opérations de maintenance et de gestion sur l'ensemble de l'application.</p>
    </div>

    <!-- SECTION : Gestion Quotidienne -->
    <div class="admin-category">
        <div class="category-header">
            <h2 class="category-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="28px">
                    <path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h168q13-36 43.5-58t68.5-22q38 0 68.5 22t43.5 58h168q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm280-670q13 0 21.5-8.5T510-820q0-13-8.5-21.5T480-850q-13 0-21.5 8.5T450-820q0 13 8.5 21.5T480-790Z"/>
                </svg>
                Gestion Quotidienne
            </h2>
            <p class="category-description">Outils essentiels pour la gestion journalière de votre laboratoire</p>
        </div>

        <div class="admin-grid">
            <!-- Carte Utilisateurs -->
            <div class="admin-card">
                <div class="card-icon-wrapper card-icon-blue">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="32px">
                        <path d="M40-160v-112q0-34 17.5-62.5T104-378q62-31 126-46.5T360-440q66 0 130 15.5T616-378q29 15 46.5 43.5T680-272v112H40Zm720 0v-120q0-44-24.5-84.5T666-434q51 6 96 20.5t84 35.5q36 20 55 44.5t19 53.5v120H760ZM360-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47Zm400-160q0 66-47 113t-113 47q-11 0-28-2.5t-28-5.5q27-32 41.5-71t14.5-81q0-42-14.5-81T544-792q14-5 28-6.5t28-1.5q66 0 113 47t47 113Z"/>
                    </svg>
                </div>
                <h3 class="card-title">Gestion des Utilisateurs</h3>
                <p class="card-description">Ajoutez, supprimez ou modifiez les comptes utilisateurs et leurs permissions</p>
                <div class="card-footer">
                    <a href="{{ url_for('admin.gestion_utilisateurs') }}" class="btn-card btn-primary">
                        Gérer
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="18px">
                            <path d="M647-440H160v-80h487L423-744l57-56 320 320-320 320-57-56 224-224Z"/>
                        </svg>
                    </a>
                </div>
            </div>

            <!-- NOUVEAU : Carte Sécurité & Maintenance -->
            <div class="admin-card">
                <div class="card-icon-wrapper" style="background: linear-gradient(135deg, #20c997 0%, #0dcaf0 100%);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="white" class="bi bi-shield-check" viewBox="0 0 16 16">
                        <path d="M5.338 1.59a61.44 61.44 0 0 0-2.837.856.481.481 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.725 10.725 0 0 0 2.287 2.233c.346.244.652.42.893.533.12.057.218.095.293.118a.55.55 0 0 0 .101.025.615.615 0 0 0 .1-.025c.076-.023.174-.061.294-.118.24-.113.547-.29.893-.533a10.726 10.726 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.118.265 7.31 0 8 0s1.882.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.775 11.775 0 0 1-2.517 2.453 7.159 7.159 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7.158 7.158 0 0 1-1.048-.625 11.777 11.777 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 62.456 62.456 0 0 1 5.072.56z"/>
                        <path d="M10.854 5.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 7.793l2.646-2.647a.5.5 0 0 1 .708 0z"/>
                    </svg>
                </div>
                <h3 class="card-title">Sécurité & Maintenance</h3>
                
                {% if securite_stats %}
                    <!-- Vue Résumé Dynamique -->
                    <div class="mt-3 mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">Équipements suivis</span>
                            <span class="fw-bold">{{ securite_stats.total_equipements }}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">Alertes en cours</span>
                            {% if securite_stats.alertes > 0 %}
                                <span class="badge bg-danger rounded-pill">{{ securite_stats.alertes }}</span>
                            {% else %}
                                <span class="badge bg-success rounded-pill">0</span>
                            {% endif %}
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ securite_stats.taux_conformite }}%"></div>
                        </div>
                        <div class="text-end small text-muted mt-1">{{ securite_stats.taux_conformite }}% Conforme</div>
                    </div>
                {% else %}
                    <!-- Vue Description Standard -->
                    <p class="card-description">Gérez vos équipements de sécurité (hottes, extincteurs) et leur maintenance réglementaire.</p>
                {% endif %}

                <div class="card-footer">
                    <a href="{{ url_for('securite.index') }}" class="btn-card btn-primary">
                        Gérer
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="18px">
                            <path d="M647-440H160v-80h487L423-744l57-56 320 320-320 320-57-56 224-224Z"/>
                        </svg>
                    </a>
                </div>
            </div>

            <!-- Carte Kits -->
            <div class="admin-card">
                <div class="card-icon-wrapper card-icon-purple">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="32px">
                        <path d="M80-160v-400q0-33 23.5-56.5T160-640h120v-80q0-33 23.5-56.5T360-800h240q33 0 56.5 23.5T680-720v80h120q33 0 56.5 23.5T880-560v400H80Zm240-480h320v-80H320v80Z"/>
                    </svg>
                </div>
                <h3 class="card-title">Gestion des Kits</h3>
                <p class="card-description">Créez et configurez des kits de matériel prédéfinis pour faciliter les réservations</p>
                <div class="card-footer">
                    <a href="{{ url_for('admin.gestion_kits') }}" class="btn-card btn-primary">
                        Gérer
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="18px">
                            <path d="M647-440H160v-80h487L423-744l57-56 320 320-320 320-57-56 224-224Z"/>
                        </svg>
                    </a>
                </div>
            </div>

            <!-- Carte Échéances -->
            <div class="admin-card">
                <div class="card-icon-wrapper card-icon-orange">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="28" height="28" fill="currentColor">
						<path d="M9.05.435c-.58-.58-1.52-.58-2.1 0L.436 6.95c-.58.58-.58 1.519 0 2.098l6.516 6.516c.58.58 1.519.58 2.098 0l6.516-6.516c.58-.58.58-1.519 0-2.098zM8 4c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995A.905.905 0 0 1 8 4m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/>
					</svg>
                </div>
                <h3 class="card-title">Gestion des Échéances</h3>
                <p class="card-description">Définissez et suivez les dates importantes : maintenances, contrats, commandes</p>
                <div class="card-footer">
                    <a href="{{ url_for('admin.gestion_echeances') }}" class="btn-card btn-primary">
                        Gérer
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="18px">
                            <path d="M647-440H160v-80h487L423-744l57-56 320 320-320 320-57-56 224-224Z"/>
                        </svg>
                    </a>
                </div>
            </div>

            <!-- Carte Budget -->
            <div class="admin-card">
                <div class="card-icon-wrapper card-icon-green">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="32px">
                        <path d="M600-120q-118 0-210-67T260-360H120v-80h122q-2-11-2-20v-40q0-9 2-20H120v-80h140q38-106 130-173t210-67q69 0 130.5 24T840-748l-70 70q-35-29-78.5-45.5T600-740q-75 0-136.5 38.5T370-600h230v80H344q-2 11-3 20t-1 20q0 11 1 20t3 20h256v80H370q32 63 93.5 101.5T600-220q48 0 92.5-16.5T770-282l70 70q-48 44-109.5 68T600-120Z"/>
                    </svg>
                </div>
                <h3 class="card-title">Gestion Budgétaire</h3>
                <p class="card-description">Suivez votre budget annuel, enregistrez vos dépenses et exportez des rapports</p>
                <div class="card-footer">
                    <a href="{{ url_for('admin.budget') }}" class="btn-card btn-primary">
                        Accéder
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="18px">
                            <path d="M647-440H160v-80h487L423-744l57-56 320 320-320 320-57-56 224-224Z"/>
                        </svg>
                    </a>
                </div>
            </div>

            <!-- Carte Fournisseurs -->
            <div class="admin-card">
                <div class="card-icon-wrapper card-icon-teal">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="32px">
                        <path d="M280-160q-50 0-85-35t-35-85H60l18-80h113q17-19 40-29.5t49-10.5q26 0 49 10.5t40 29.5h167l84-360H182l4-17q6-28 27.5-45.5T264-800h456l-37 160h117l120 160-40 200h-80q0 50-35 85t-85 35q-50 0-85-35t-35-85H400q0 50-35 85t-85 35Z"/>
                    </svg>
                </div>
                <h3 class="card-title">Gestion des Fournisseurs</h3>
                <p class="card-description">Consultez, ajoutez ou supprimez les fiches des fournisseurs référencés</p>
                <div class="card-footer">
                    <a href="{{ url_for('admin.gestion_fournisseurs') }}" class="btn-card btn-primary">
                        Gérer
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="18px">
                            <path d="M647-440H160v-80h487L423-744l57-56 320 320-320 320-57-56 224-224Z"/>
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- SECTION : Analyse et Exports -->
    <div class="admin-category">
        <div class="category-header">
            <h2 class="category-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="28px">
                    <path d="m105-399-65-47 200-320 120 140 160-260 120 180 135-214 65 47-198 314-119-179-152 247-121-141-145 233Z"/>
                </svg>
                Analyse et Exports
            </h2>
            <p class="category-description">Outils d'analyse et d'export pour vos données</p>
        </div>

        <div class="admin-grid">
            <!-- Carte Import -->
            <div class="admin-card">
                <div class="card-icon-wrapper card-icon-indigo">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="32px">
                        <path d="M240-160q-33 0-56.5-23.5T160-240v-480q0-33 23.5-56.5T240-800h360l160 160v400q0 33-23.5 56.5T720-160H240Zm0-80h480v-360H560v-120H240v480Z"/>
                    </svg>
                </div>
                <h3 class="card-title">Importation en Masse</h3>
                <p class="card-description">Ajoutez plusieurs objets à votre inventaire en une seule fois via Excel</p>
                <div class="card-footer">
                    <a href="{{ url_for('admin.importer_page') }}" class="btn-card btn-primary">
                        Importer
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="18px">
                            <path d="M647-440H160v-80h487L423-744l57-56 320 320-320 320-57-56 224-224Z"/>
                        </svg>
                    </a>
                </div>
            </div>

            <!-- Carte Rapports -->
            <div class="admin-card">
                <div class="card-icon-wrapper card-icon-pink">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="32px">
                        <path d="m105-399-65-47 200-320 120 140 160-260 120 180 135-214 65 47-198 314-119-179-152 247-121-141-145 233Zm475 159q42 0 71-29t29-71q0-42-29-71t-71-29q-42 0-71 29t-29 71q0 42 29 71t71 29Z"/>
                    </svg>
                </div>
                <h3 class="card-title">Rapports d'Activité</h3>
                <p class="card-description">Générez des rapports détaillés sur l'utilisation du matériel et les réservations</p>
                <div class="card-footer">
                    <a href="{{ url_for('admin.rapports') }}" class="btn-card btn-primary">
                        Générer
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="18px">
                            <path d="M647-440H160v-80h487L423-744l57-56 320 320-320 320-57-56 224-224Z"/>
                        </svg>
                    </a>
                </div>
            </div>

            <!-- Carte Export Inventaire -->
            <div class="admin-card card-wide">
                <div class="card-icon-wrapper card-icon-cyan">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="32px">
                        <path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h160v-40h240v40h160q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Z"/>
                    </svg>
                </div>
                <h3 class="card-title">Exporter l'Inventaire Complet</h3>
                <p class="card-description">Obtenez une liste complète de tous les objets avec leur stock disponible actuel</p>
                <div class="card-footer card-footer-multiple">
                    <a href="{{ url_for('admin.exporter_inventaire', format='pdf') }}" class="btn-card btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="18px">
                            <path d="M320-240h320v-80H320v80Zm0-160h320v-80H320v80ZM240-80q-33 0-56.5-23.5T160-160v-640q0-33 23.5-56.5T240-880h320l240 240v480q0 33-23.5 56.5T720-80H240Z"/>
                        </svg>
                        Export PDF
                    </a>
                    <a href="{{ url_for('admin.exporter_inventaire', format='excel') }}" class="btn-card btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="18px">
                            <path d="M240-160q-33 0-56.5-23.5T160-240v-480q0-33 23.5-56.5T240-800h360l160 160v400q0 33-23.5 56.5T720-160H240Z"/>
                        </svg>
                        Export Excel
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- SECTION : Administration du Système -->
    <div class="admin-category">
        <div class="category-header">
            <h2 class="category-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="28px">
                    <path d="m370-80-16-128q-13-5-24.5-12T307-235l-119 50L78-375l103-78q-1-7-1-13.5v-27q0-6.5 1-13.5L78-585l110-190 119 50q11-8 23-15t24-12l16-128h220l16 128q13 5 24.5 12t22.5 15l119-50 110 190-103 78q1 7 1 13.5v27q0 6.5-2 13.5l103 78-110 190-118-50q-11 8-23 15t-24 12L590-80H370Z"/>
                </svg>
                Administration du Système
            </h2>
            <p class="category-description">Configuration avancée et maintenance de l'application</p>
        </div>

        <div class="admin-grid">
            <!-- Carte Base de Données -->
            <div class="admin-card">
                <div class="card-icon-wrapper" style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="32" height="32" fill="white">
                        <path d="M8.5 1.5A1.5 1.5 0 0 1 10 0h4a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h6c-.314.418-.5.937-.5 1.5v7.793L4.854 6.646a.5.5 0 1 0-.708.708l3.5 3.5a.5.5 0 0 0 .708 0l3.5-3.5a.5.5 0 0 0-.708-.708L8.5 9.293z"/>
                    </svg>
                </div>
                <h3 class="card-title">Sauvegardes & Restauration</h3>
                <p class="card-description">Gérez vos points de restauration, exportez vos données JSON et restaurez l'état du laboratoire.</p>
                <div class="card-footer">
                    <a href="{{ url_for('admin.gestion_sauvegardes') }}" class="btn-card btn-primary">
                        Accéder au gestionnaire
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="18px">
                            <path d="M647-440H160v-80h487L423-744l57-56 320 320-320 320-57-56 224-224Z"/>
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% include '_modale_warning.html' %}
{% include '_modals.html' %}
{% endblock %}