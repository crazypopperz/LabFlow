<table class="objet-table">
    <thead>
		<tr>
			{% if session.user_role == 'admin' and pagination.endpoint != 'inventaire.inventaire' %}<th class="checkbox-column"><input type="checkbox" id="select-all-checkbox" title="Tout sélectionner"></th>{% endif %}
			
			{# --- DÉBUT DES LIENS DE TRI CORRIGÉS (SYNTAXE JINJA2 CORRECTE) --- #}
			<th class="sortable {% if sort_by == 'nom' %}th-sort-{{ direction }}{% endif %}">
				<a href="{{ url_for(pagination.endpoint, page=pagination.page, sort_by='nom', direction='desc' if sort_by == 'nom' and direction == 'asc' else 'asc', armoire_id=armoire.id if armoire else request.args.get('armoire_id'), categorie_id=categorie.id if categorie else request.args.get('categorie_id'), q=request.args.get('q'), etat=request.args.get('etat')) }}">Nom</a>
			</th>
			<th class="sortable {% if sort_by == 'quantite' %}th-sort-{{ direction }}{% endif %}">
				<a href="{{ url_for(pagination.endpoint, page=pagination.page, sort_by='quantite', direction='desc' if sort_by == 'quantite' and direction == 'asc' else 'asc', armoire_id=armoire.id if armoire else request.args.get('armoire_id'), categorie_id=categorie.id if categorie else request.args.get('categorie_id'), q=request.args.get('q'), etat=request.args.get('etat')) }}">Quantité</a>
			</th>
			<th class="sortable {% if sort_by == 'seuil' %}th-sort-{{ direction }}{% endif %}">
				<a href="{{ url_for(pagination.endpoint, page=pagination.page, sort_by='seuil', direction='desc' if sort_by == 'seuil' and direction == 'asc' else 'asc', armoire_id=armoire.id if armoire else request.args.get('armoire_id'), categorie_id=categorie.id if categorie else request.args.get('categorie_id'), q=request.args.get('q'), etat=request.args.get('etat')) }}">Seuil</a>
			</th>
			<th class="sortable {% if sort_by == 'date_peremption' %}th-sort-{{ direction }}{% endif %}">
				<a href="{{ url_for(pagination.endpoint, page=pagination.page, sort_by='date_peremption', direction='desc' if sort_by == 'date_peremption' and direction == 'asc' else 'asc', armoire_id=armoire.id if armoire else request.args.get('armoire_id'), categorie_id=categorie.id if categorie else request.args.get('categorie_id'), q=request.args.get('q'), etat=request.args.get('etat')) }}">Péremption</a>
			</th>
			<th class="sortable {% if sort_by == 'categorie' %}th-sort-{{ direction }}{% endif %}">
				<a href="{{ url_for(pagination.endpoint, page=pagination.page, sort_by='categorie', direction='desc' if sort_by == 'categorie' and direction == 'asc' else 'asc', armoire_id=armoire.id if armoire else request.args.get('armoire_id'), categorie_id=categorie.id if categorie else request.args.get('categorie_id'), q=request.args.get('q'), etat=request.args.get('etat')) }}">Catégorie</a>
			</th>
			<th class="sortable {% if sort_by == 'armoire' %}th-sort-{{ direction }}{% endif %}">
				<a href="{{ url_for(pagination.endpoint, page=pagination.page, sort_by='armoire', direction='desc' if sort_by == 'armoire' and direction == 'asc' else 'asc', armoire_id=armoire.id if armoire else request.args.get('armoire_id'), categorie_id=categorie.id if categorie else request.args.get('categorie_id'), q=request.args.get('q'), etat=request.args.get('etat')) }}">Armoire</a>
			</th>
			{# --- FIN DES LIENS DE TRI CORRIGÉS --- #}

			<th>Image</th>
			<th>État</th>
			{% if session.user_id %}<th>Actions</th>{% endif %}
		</tr>
	</thead>
    <tbody>
        {% for objet in objets %}
        {% set perime, perime_bientot, statut = False, False, 'ok' %}
        {% if objet.date_peremption %}
            {% set date_peremption_obj = date_actuelle.strptime(objet.date_peremption, '%Y-%m-%d') %}
            {% if date_peremption_obj < date_actuelle %}{% set perime, statut = True, 'perime' %}
            {% elif (date_peremption_obj - date_actuelle).days <= 30 %}{% set perime_bientot, statut = True, 'bientot' %}
            {% endif %}
        {% endif %}
        {% if statut == 'ok' and objet.quantite_disponible <= objet.seuil %}{% set statut = 'stock' %}{% endif %}

        <tr class="{{ 'row-perime' if perime else 'row-perime-bientot' if perime_bientot }}" data-objet-id="{{ objet.id }}">
            {% if session.user_role == 'admin' and pagination.endpoint != 'inventaire.inventaire' %}<td class="checkbox-column"><input type="checkbox" class="objet-checkbox" data-id="{{ objet.id }}"></td>{% endif %}
            <td data-field="nom"><a href="{{ url_for('inventaire.voir_objet', objet_id=objet.id) }}">{{ objet.nom }}</a></td>
            <td data-field="quantite">{{ objet.quantite_disponible }}</td>
            <td data-field="seuil">{{ objet.seuil }}</td>
            <td data-field="date_peremption" class="{{ 'texte-perime' if perime else 'texte-perime-bientot' if perime_bientot }}">{{ date_peremption_obj.strftime('%d/%m/%Y') if objet.date_peremption }}</td>
            <td data-field="categorie">{{ objet.categorie }}</td>
            <td data-field="armoire">{{ objet.armoire }}</td>
            <td class="image-cell">
				<div class="image-preview-wrapper">
					{# --- CORRECTION LOGIQUE IMAGE --- #}
                    {% if objet.image_url %}
						<img src="{{ objet.image_url }}" class="image-objet-thumbnail" alt="Image de {{ objet.nom }}">
						<img src="{{ objet.image_url }}" class="image-objet-preview" alt="Aperçu de {{ objet.nom }}">
					{% endif %}
				</div>
			</td>
            <td data-type="alerte" data-alerte-status="{{ statut }}">
                {% if statut == 'perime' %}<span class="texte-perime" title="Produit périmé. A recycler !"><svg ...></svg></span>
                {% elif statut == 'bientot' %}<span class="texte-perime-bientot" title="Expire bientôt"><svg ...></svg></span>
                {% elif statut == 'stock' %}<span class="texte-alerte" title="Stock bas"><svg ...></svg></span>
                {% else %}<span class="texte-ok" title="OK"><svg ...></svg></span>
                {% endif %}
            </td>
            {% if session.user_id %}
            <td class="actions-cell">
                <button class="btn-action edit-objet-btn"
                        data-objet-id="{{ objet.id }}"
                        data-armoire-id="{{ objet.armoire_id }}"
                        data-categorie-id="{{ objet.categorie_id }}"
                        data-nom="{{ objet.nom }}"
                        data-quantite="{{ objet.quantite_physique }}"
                        data-seuil="{{ objet.seuil }}"
                        data-date-peremption="{{ objet.date_peremption or '' }}"
                        data-image-url="{{ objet.image_url or '' }}"
                        data-modal-trigger="add-object-modal">
                    Modifier
                </button>
                {% if session.user_role == 'admin' %}
                <form class="form-in-cell" action="{{ url_for('inventaire.supprimer_objet', id_objet=objet.id) }}" method="post">
					<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
					<button type="button" class="btn-action btn-danger btn-delete-objet" data-objet-nom="{{ objet.nom }}">Supprimer</button>
				</form>
				{% endif %}
            </td>
            {% endif %}
        </tr>
        {% endfor %}
    </tbody>
</table>
{% include '_pagination.html' %}