{% extends "base.html" %}

{% block title %}Gestion des Échéances - LabFlow{% endblock %}

{% block content %}
*
<div class="main-container">
    {% include '_breadcrumb.html' %}

    <!-- En-tête -->
    <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom">
        <h2 class="h3 mb-0 text-dark d-flex align-items-center gap-3">
            <!-- Icône Orange (Harmonisée avec Dashboard) -->
            <div class="rounded-3 d-flex align-items-center justify-content-center text-white shadow-sm" 
                 style="width: 48px; height: 48px; background: linear-gradient(135deg, #ff9a56 0%, #ff6a88 100%);">
                <!-- SVG Losange Alerte -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="28" height="28" fill="currentColor">
                    <path d="M9.05.435c-.58-.58-1.52-.58-2.1 0L.436 6.95c-.58.58-.58 1.519 0 2.098l6.516 6.516c.58.58 1.519.58 2.098 0l6.516-6.516c.58-.58.58-1.519 0-2.098zM8 4c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995A.905.905 0 0 1 8 4m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/>
                </svg>
            </div>
            <span class="fw-bold">Gestion des Échéances</span>
        </h2>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#echeanceModal" onclick="resetModal()">
            <i class="bi bi-plus-lg me-2"></i> Ajouter une échéance
        </button>
    </div>

    <!-- Tableau -->
    <div class="card border-0 shadow-sm rounded-3 overflow-hidden">
        <div class="table-responsive">
            <table class="echeance-table mb-0">
                <thead>
                    <tr>
                        <th style="width: 150px;">Date</th>
                        <th>Intitulé</th>
                        <th>Détails</th>
                        <th style="width: 140px;">Statut</th>
                        <th class="text-end" style="width: 100px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if echeances %}
                        {% for echeance in echeances %}
                            <!-- Calcul du statut pour le style -->
                            {% set is_late = (not echeance.traite and echeance.date_echeance < date_actuelle) %}
                            {% set is_soon = (not echeance.traite and (echeance.date_echeance - date_actuelle).days < 30 and not is_late) %}
                            
                            <tr class="{{ 'row-done' if echeance.traite else '' }}">
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="bi bi-calendar3 text-muted"></i>
                                        <span class="fw-medium">{{ echeance.date_echeance.strftime('%d/%m/%Y') }}</span>
                                    </div>
                                </td>
                                <td>
                                    <strong class="d-block text-dark">{{ echeance.intitule }}</strong>
                                </td>
                                <td class="text-muted small">
                                    {{ echeance.details or '-' }}
                                </td>
                                <td>
                                    {% if echeance.traite %}
                                        <span class="status-badge status-done"><i class="bi bi-check-circle-fill"></i> Traité</span>
                                    {% elif is_late %}
                                        <span class="status-badge status-danger"><i class="bi bi-exclamation-triangle-fill"></i> Retard</span>
                                    {% elif is_soon %}
                                        <span class="status-badge status-warning"><i class="bi bi-clock-history"></i> Bientôt</span>
                                    {% else %}
                                        <span class="status-badge status-ok"><i class="bi bi-hourglass-split"></i> En cours</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <!-- Wrapper Flexbox pour aligner les boutons -->
                                    <div class="actions-wrapper">
                                        <!-- Modifier -->
                                        <button class="btn btn-sm btn-outline-primary btn-icon-only" 
                                                title="Modifier"
                                                onclick='openEditModal({{ echeance.id }}, "{{ echeance.intitule|replace('"', '&quot;') }}", "{{ echeance.date_echeance.strftime('%Y-%m-%d') }}", "{{ (echeance.details or "")|replace('"', '&quot;')|replace('\n', ' ')|replace('\r', '') }}", {{ "true" if echeance.traite else "false" }})'>
                                            <i class="bi bi-pencil-fill"></i>
                                        </button>
                                        
                                        <!-- Supprimer -->
                                        <button class="btn btn-sm btn-outline-danger btn-icon-only" 
                                                title="Supprimer"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#deleteModal"
                                                data-url="{{ url_for('admin.supprimer_echeance', id=echeance.id) }}">
                                            <i class="bi bi-trash-fill"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-5 text-muted">
                                <i class="bi bi-calendar-x display-4 d-block mb-3 opacity-25"></i>
                                Aucune échéance enregistrée.
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modale Ajout/Modification -->
<div class="modal fade" id="echeanceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitle"><i class="bi bi-calendar-plus me-2"></i>Nouvelle Échéance</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="echeanceForm" action="{{ url_for('admin.ajouter_echeance') }}" method="post">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="mb-3">
                        <label class="form-label">Intitulé *</label>
                        <input type="text" class="form-control" name="intitule" id="inputIntitule" required placeholder="Ex: Renouvellement contrat maintenance">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Date d'échéance *</label>
                        <input type="date" class="form-control" name="date_echeance" id="inputDate" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Détails</label>
                        <textarea class="form-control" name="details" id="inputDetails" rows="3"></textarea>
                    </div>

                    <!-- Checkbox visible uniquement en mode édition -->
                    <div class="form-check d-none" id="divTraite">
                        <input class="form-check-input" type="checkbox" name="traite" id="checkTraite">
                        <label class="form-check-label" for="checkTraite">
                            Marquer comme traitée / terminée
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modale Suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Supprimer l'échéance</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Voulez-vous vraiment supprimer cette échéance ?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <form id="deleteForm" method="post" action="">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">Supprimer</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Réinitialiser la modale pour l'ajout
    function resetModal() {
        document.getElementById('modalTitle').innerHTML = '<i class="bi bi-calendar-plus me-2"></i>Nouvelle Échéance';
        document.getElementById('echeanceForm').action = "{{ url_for('admin.ajouter_echeance') }}";
        document.getElementById('inputIntitule').value = '';
        document.getElementById('inputDate').value = '';
        document.getElementById('inputDetails').value = '';
        document.getElementById('checkTraite').checked = false;
        document.getElementById('divTraite').classList.add('d-none'); // Cacher le statut traité à la création
    }

    // Remplir la modale pour l'édition
    function openEditModal(id, intitule, date, details, traite) {
        // Ouvrir la modale via Bootstrap
        const modal = new bootstrap.Modal(document.getElementById('echeanceModal'));
        modal.show();

        // Remplir les champs
        document.getElementById('modalTitle').innerHTML = '<i class="bi bi-pencil-square me-2"></i>Modifier l\'échéance';
        document.getElementById('echeanceForm').action = "/admin/echeances/modifier/" + id;
        document.getElementById('inputIntitule').value = intitule;
        document.getElementById('inputDate').value = date;
        document.getElementById('inputDetails').value = details;
        
        // Gérer la case à cocher
        const checkTraite = document.getElementById('checkTraite');
        checkTraite.checked = traite;
        document.getElementById('divTraite').classList.remove('d-none'); // Afficher le statut traité
    }

    // Gestion suppression
    const deleteModal = document.getElementById('deleteModal');
    if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const url = button.dataset.url;
            document.getElementById('deleteForm').action = url;
        });
    }
</script>
{% endblock %}