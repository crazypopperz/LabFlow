<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gestion des Fournisseurs</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/script.js') }}" defer></script>
</head>
<body>
    {% include 'header.html' %}
    <div class="main-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
            {% for category, message in messages %}
                <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
            </div>
        {% endif %}
        {% endwith %}
        
        {% include '_breadcrumb.html' %}

        <div class="management-header">
            <h2 class="page-title">
                <svg class="page-title-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M240-160q-50 0-85-35t-35-85H40v-440q0-33 23.5-56.5T120-800h560v160h120l120 160v200h-80q0 50-35 85t-85 35q-50 0-85-35t-35-85H360q0 50-35 85t-85 35Zm0-80q17 0 28.5-11.5T280-280q0-17-11.5-28.5T240-320q-17 0-28.5 11.5T200-280q0 17 11.5 28.5T240-240ZM120-360h32q17-18 39-29t49-11q27 0 49 11t39 29h272v-360H120v360Zm600 120q17 0 28.5-11.5T760-280q0-17-11.5-28.5T720-320q-17 0-28.5 11.5T680-280q0 17 11.5 28.5T720-240Zm-40-200h170l-90-120h-80v120ZM360-540Z"/></svg>
                <span>Gestion des Fournisseurs</span>
            </h2>
            <button class="btn-action" data-modal-trigger="ajout-fournisseur-modal">Ajouter un fournisseur</button>
        </div>

        <div class="content-card">
            <div class="table-container">
                <table class="objet-table">
                    <thead>
                        <tr>
                            <th style="width: 80px;">Logo</th>
                            <th>Nom du Fournisseur</th>
                            <th>Site Web</th>
                            <th style="width: 120px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in fournisseurs %}
                        <tr>
                            <td class="image-cell">
                                {% if item.Fournisseur.logo %}
                                <div class="image-preview-wrapper">
                                    <!-- CORRECTION : On utilise directement l'URL du logo -->
                                    <img src="{{ item.Fournisseur.logo }}" class="image-objet-thumbnail" alt="Logo de {{ item.Fournisseur.nom }}" onerror="this.style.display='none'">
                                    <img src="{{ item.Fournisseur.logo }}" class="image-objet-preview" alt="Aperçu du logo de {{ item.Fournisseur.nom }}">
                                </div>
                                {% endif %}
                            </td>
                            <td>{{ item.Fournisseur.nom }}</td>
                            <td class="url-cell">
                                {% if item.Fournisseur.site_web %}
                                    <a href="{{ item.Fournisseur.site_web }}" target="_blank" rel="noopener noreferrer">{{ item.Fournisseur.site_web }}</a>
                                {% else %}
                                    <span class="text-discret">N/A</span>
                                {% endif %}
                            </td>
                            <td class="actions-cell">
                                <button class="btn-action btn-icon-only" 
                                        title="Modifier ce fournisseur"
                                        data-modal-trigger="edit-fournisseur-modal"
                                        data-id="{{ item.Fournisseur.id }}"
                                        data-nom="{{ item.Fournisseur.nom }}"
                                        data-site-web="{{ item.Fournisseur.site_web or '' }}"
                                        data-logo-url="{{ item.Fournisseur.logo or '' }}">
                                    <svg style="width:24px;height:24px" viewBox="0 0 24 24"><path fill="currentColor" d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>
                                </button>
                                <form class="form-in-cell delete-form-interactive" 
                                      action="{{ url_for('admin.supprimer_fournisseur', id=item.Fournisseur.id) }}" 
                                      method="post"
                                      data-item-type="fournisseur"
                                      data-item-name="{{ item.Fournisseur.nom }}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="button" class="btn-action btn-icon-only delete-btn" title="Supprimer ce fournisseur" {% if item.depenses_count > 0 %}disabled{% endif %}>
                                        <svg style="width:24px;height:24px" viewBox="0 0 24 24"><path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-discret" style="text-align: center; padding: 20px;">Aucun fournisseur n'a été ajouté.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modale d'Ajout -->
    <div id="ajout-fournisseur-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title-with-icon">Ajouter un Fournisseur</h3>
                <button class="close-btn">×</button>
            </div>
            <!-- CORRECTION : L'action pointe vers la bonne route et plus de 'enctype' -->
            <form action="{{ url_for('admin.ajouter_fournisseur') }}" method="post" class="modal-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-group">
                    <label for="nom">Nom du fournisseur</label>
                    <input type="text" id="nom" name="nom" required>
                </div>
                <div class="form-group">
                    <label for="site_web">Site Web (optionnel)</label>
                    <input type="url" id="site_web" name="site_web" placeholder="https://www.example.com">
                </div>
                <div class="form-group">
                    <label for="logo_url">URL du logo (optionnel)</label>
                    <input type="url" id="logo_url" name="logo_url" placeholder="https://example.com/logo.png">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-action btn-cancel">Annuler</button>
                    <button type="submit" class="btn-action">Ajouter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modale de Modification -->
    <div id="edit-fournisseur-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title-with-icon">Modifier le fournisseur</h3>
                <button class="close-btn">×</button>
            </div>
            <form action="" method="post" class="modal-form" id="edit-fournisseur-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-group">
                    <label for="edit_nom">Nom du fournisseur</label>
                    <input type="text" id="edit_nom" name="nom" required>
                </div>
                <div class="form-group">
                    <label for="edit_site_web">Site Web</label>
                    <input type="url" id="edit_site_web" name="site_web" placeholder="https://www.example.com">
                </div>
                <div class="form-group">
                    <label for="edit_logo_url">URL du logo</label>
                    <input type="url" id="edit_logo_url" name="logo_url" placeholder="https://example.com/logo.png">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-action btn-cancel">Annuler</button>
                    <button type="submit" class="btn-action">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    {% include '_modale_danger.html' %}
    {% include 'footer.html' %}
</body>
</html>