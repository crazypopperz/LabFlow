{% extends "base.html" %}

{% block title %}Tableau de Bord - LabFlow{% endblock %}

{% block head_styles %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}

    <div class="main-container" data-add-url="{{ url_for('inventaire.ajouter_objet') }}" data-icon-url="{{ url_for('static', filename='icons/ajout.png') }}">

        <!-- ============================================================ -->
        <!-- MODIFICATION : Le bloc "messages flash" a été supprimé d'ici. -->
        <!-- Il est maintenant géré par base.html pour s'afficher en "toast". -->
        <!-- ============================================================ -->

        <div class="page-header">
            <h2 class="page-title">
                <svg xmlns="http://www.w3.org/2000/svg" class="page-title-icon" viewBox="0 -960 960 960"><path d="M160-120q-33 0-56.5-23.5T80-200v-560q0-33 23.5-56.5T160-840h560q33 0 56.5 23.5T800-760v80h80v80h-80v80h80v80h-80v80h80v80h-80v80q0 33-23.5 56.5T720-120H160Zm0-80h560v-560H160v560Zm80-80h200v-160H240v160Zm240-280h160v-120H480v120Zm-240 80h200v-200H240v200Zm240 200h160v-240H480v240ZM160-760v560-560Z"/></svg>
                <span>Tableau de Bord</span>
            </h2>
        </div>

        <div class="dashboard-grid">

            <!-- Widget Suivi Budgétaire -->
			<div class="dashboard-widget">
				<div class="widget-header">
					<svg class="widget-icon" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"><path d="M640-520q17 0 28.5-11.5T680-560q0-17-11.5-28.5T640-600q-17 0-28.5 11.5T600-560q0 17 11.5 28.5T640-520Zm-320-80h200v-80H320v80ZM180-120q-34-114-67-227.5T80-580q0-92 64-156t156-64h200q29-38 70.5-59t89.5-21q25 0 42.5 17.5T720-820q0 6-1.5 12t-3.5 11q-4 11-7.5 22.5T702-751l91 91h87v279l-113 37-67 224H480v-80h-80v80H180Zm60-80h80v-80h240v80h80l62-206 98-33v-141h-40L620-720q0-20 2.5-38.5T630-796q-29 8-51 27.5T547-720H300q-58 0-99 41t-41 99q0 98 27 191.5T240-200Zm240-298Z"/></svg><h3>Suivi Budgétaire</h3>
				</div>
				<div class="widget-content">
					{% if data.solde_budget is not none %}
						<div class="budget-display">
							<span class="budget-label">Solde Actuel</span>
							<span class="budget-value {{ 'positive' if data.solde_budget >= 0 else 'negative' }}">
								{{ "%.2f"|format(data.solde_budget) }} €
							</span>
						</div>
					{% else %}
						<div class="widget-placeholder">
							<p>Aucun budget n'a été défini pour l'année en cours.</p>
						</div>
					{% endif %}
				</div>
                <div class="widget-footer">
                    {% if data.solde_budget is not none %}
                        <a href="{{ url_for('admin.budget') }}" class="btn-widget">Consulter le budget</a>
                    {% elif session.user_role == 'admin' %}
                        <a href="{{ url_for('admin.budget') }}" class="btn-widget">Définir le budget</a>
                    {% endif %}
                </div>
			</div>

			<!-- WIDGET PROCHAINES ÉCHÉANCES -->
			<div class="dashboard-widget">
				<div class="widget-header">
					<svg class="widget-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M200-80q-33 0-56.5-23.5T120-160v-560q0-33 23.5-56.5T200-800h40v-80h80v80h320v-80h80v80h40q33 0 56.5 23.5T840-720v560q0 33-23.5 56.5T760-80H200Zm0-80h560v-400H200v400Zm0-480h560v-80H200v80Zm0 0v-80 80Zm280 240q-17 0-28.5-11.5T440-440q0-17 11.5-28.5T480-480q17 0 28.5 11.5T520-440q0 17-11.5 28.5T480-400Zm-160 0q-17 0-28.5-11.5T280-440q0-17 11.5-28.5T320-480q17 0 28.5 11.5T360-440q0 17-11.5 28.5T320-400Zm320 0q-17 0-28.5-11.5T600-440q0-17 11.5-28.5T640-480q17 0 28.5 11.5T680-440q0 17-11.5 28.5T640-400ZM480-240q-17 0-28.5-11.5T440-280q0-17 11.5-28.5T480-320q17 0 28.5 11.5T520-280q0 17-11.5 28.5T480-240Zm-160 0q-17 0-28.5-11.5T280-280q0-17 11.5-28.5T320-320q17 0 28.5 11.5T360-280q0 17-11.5 28.5T320-240Zm320 0q-17 0-28.5-11.5T600-280q0-17 11.5-28.5T640-320q17 0 28.5 11.5T680-280q0 17-11.5 28.5T640-240Z"/></svg>
					<h3>Prochaines Échéances</h3>
				</div>
				<div class="widget-content">
					<ul class="widget-list">
						{% for echeance in data.prochaines_echeances %}
						<li class="dashboard-list-item">
							<div class="item-main-info">
								<span class="item-title">{{ echeance.intitule }}</span>
								<span class="item-subtitle">Pour le {{ echeance.date_echeance_obj|strftime('%d/%m/%Y') }}</span>
							</div>
							<span class="action-tag-small {% if echeance.jours_restants < 7 %}texte-perime{% elif echeance.jours_restants < 15 %}texte-perime-bientot{% endif %}">
								J-{{ echeance.jours_restants }}
							</span>
						</li>
						{% else %}
						<div class="widget-placeholder">
							<p>Aucune échéance prévue dans les 30 prochains jours.</p>
						</div>
						{% endfor %}
					</ul>
				</div>
				<div class="widget-footer">
				    {% if session.user_role == 'admin' %}
					    <a href="{{ url_for('admin.gestion_echeances') }}" class="btn-widget">Gérer toutes les échéances</a>
				    {% endif %}
				</div>
			</div>
			
			<!-- Widget Mes Réservations -->
			<div class="dashboard-widget">
				<div class="widget-header">
					<svg class="widget-icon" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"><path d="M582-298 440-440v-200h80v167l118 118-56 57ZM440-720v-80h80v80h-80Zm280 280v-80h80v80h-80ZM440-160v-80h80v80h-80ZM160-440v-80h80v80h-80ZM480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg><h3>Mes Prochaines Réservations</h3>
				</div>
				<div class="widget-content">
					{% if data.reservations %}
						<ul class="widget-list">
						{% for resa in data.reservations %}
							<li class="dashboard-list-item">
								<div class="item-main-info">
									<span class="item-title">{{ resa.debut_reservation|strftime_fr('%A %d %B à %Hh%M') }} ({{ resa.item_count }} article{% if resa.item_count > 1 %}s{% endif %})</span>
								</div>
							</li>
						{% endfor %}
						</ul>
					{% else %}
						<div class="widget-placeholder">
							<p>Vous n'avez aucune réservation à venir.</p>
						</div>
					{% endif %}
				</div>
                <div class="widget-footer">
                    <a href="{{ url_for('main.calendrier') }}" class="btn-widget">Réserver du matériel</a>
                </div>
			</div>
			
			<!-- WIDGET FOURNISSEURS -->
            <div class="dashboard-widget">
                <div class="widget-header">
                    <svg class="widget-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M240-160q-50 0-85-35t-35-85H40v-440q0-33 23.5-56.5T120-800h560v160h120l120 160v200h-80q0 50-35 85t-85 35q-50 0-85-35t-35-85H360q0 50-35 85t-85 35Zm0-80q17 0 28.5-11.5T280-280q0-17-11.5-28.5T240-320q-17 0-28.5 11.5T200-280q0 17 11.5 28.5T240-240ZM120-360h32q17-18 39-29t49-11q27 0 49 11t39 29h272v-360H120v360Zm600 120q17 0 28.5-11.5T760-280q0-17-11.5-28.5T720-320q-17 0-28.5 11.5T680-280q0 17 11.5 28.5T720-240Zm-40-200h170l-90-120h-80v120ZM360-540Z"/></svg>
                    <h3>Fournisseurs</h3>
                </div>
                <div class="widget-content">
                    <div class="widget-placeholder">
                        <p>Consultez la liste de nos fournisseurs référencés.</p>
                    </div>
                </div>
                <div class="widget-footer">
                    <a href="{{ url_for('admin.gestion_fournisseurs') }}" class="btn-widget">Voir les fournisseurs</a>
                </div>
            </div>

			<!-- Widget Mon Historique Récent -->
			<div class="dashboard-widget">
				<div class="widget-header">
					<svg class="widget-icon" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"><path d="M160-200v-440 440-15 15Zm0 80q-33 0-56.5-23.5T80-200v-440q0-33 23.5-56.5T160-720h160v-80q0-33 23.5-56.5T400-880h160q33 0 56.5 23.5T640-800v80h160q33 0 56.5 23.5T880-640v171q-18-13-38-22.5T800-508v-132H160v440h283q3 21 9 41t15 39H160Zm240-600h160v-80H400v80ZM720-40q-83 0-141.5-58.5T520-240q0-83 58.5-141.5T720-440q83 0 141.5 58.5T920-240q0 83-58.5 141.5T720-40Zm20-208v-112h-40v128l86 86 28-28-74-74Z"/></svg><h3>Mon Historique Récent</h3>
				</div>
				<div class="widget-content">
					{% if data.historique_recent %}
						<ul class="widget-list">
						{% for action in data.historique_recent %}
							<li class="dashboard-list-item">
								<div class="item-main-info">
									{% if action.type == 'reservation' %}
                                        <span class="item-title">Réservation effectuée</span>
									{% else %}
										<span class="item-title">{{ action.details }}</span>
									{% endif %}
									<span class="item-subtitle">{{ action.timestamp|strftime('%d/%m/%Y %H:%M') }}</span>
								</div>
								<span class="action-tag-small">{{ action.action }}</span>
							</li>
						{% endfor %}
						</ul>
					{% else %}
						<div class="widget-placeholder">
							<p>Aucune activité récente enregistrée.</p>
						</div>
					{% endif %}
				</div>
                <div class="widget-footer"></div> <!-- Footer vide pour l'alignement -->
			</div>

			<!-- WIDGET NOUVEAUTÉS & CONTACT -->
            <div class="dashboard-widget">
                <div class="widget-header">
                    <svg class="widget-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M80-560q0-100 44.5-183.5T244-882l47 64q-60 44-95.5 111T160-560H80Zm720 0q0-80-35.5-147T669-818l47-64q75 55 119.5 138.5T880-560h-80ZM160-200v-80h80v-280q0-83 50-147.5T420-792v-28q0-25 17.5-42.5T480-880q25 0 42.5 17.5T540-820v28q80 20 130 84.5T720-560v280h80v80H160Zm320-300Zm0 420q-33 0-56.5-23.5T400-160h160q0 33-23.5 56.5T480-80ZM320-280h320v-280q0-66-47-113t-113-47q-66 0-113 47t-47 113v280Z"/></svg>
                    <h3>Nouveautés & Contact</h3>
                </div>
                <div class="widget-content">
                    <h4 class="widget-subtitle">Ajouts récents (-24h)</h4>
                    {% if data.objets_recents %}
                        <ul class="widget-list">
                        {% for objet in data.objets_recents %}
                            <li class="dashboard-list-item">
                                <span class="item-title">{{ objet.nom }}</span>
                                <a href="{{ url_for('inventaire.voir_objet', objet_id=objet.id) }}" class="btn btn-light btn-compact">Détails</a>
                            </li>
                        {% endfor %}
                        </ul>
                    {% else %}
                        <div class="widget-placeholder" style="padding: 10px 0;">
                            <p>Aucun objet ajouté ou réapprovisionné dans les dernières 24h.</p>
                        </div>
                    {% endif %}
                </div>
                <div class="widget-footer">
                    <a href="mailto:{{ data.admin_contact }}" class="btn-widget">
                        <span>Contacter l'admin</span>
                    </a>
                </div>
            </div>

            <!-- WIDGET ADMIN -->
			{% if session.user_role == 'admin' and data.stats %}
			<div class="dashboard-widget">
				<div class="widget-header">
					<svg class="widget-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M80-120v-80h800v80H80Zm40-120v-280h120v280H120Zm200 0v-480h120v480H320Zm200 0v-360h120v360H520Zm200 0v-600h120v600H720Z"/></svg>
					<h3>Statistiques Clés</h3>
				</div>
				<div class="widget-content">
					<ul class="widget-list">
						<li class="stat-item">
							<span>Objets référencés</span>
							<span class="stat-value">{{ data.stats.total_objets }}</span>
						</li>
						<li class="stat-item">
							<span>Utilisateurs inscrits</span>
							<span class="stat-value">{{ data.stats.total_utilisateurs }}</span>
						</li>
						<li class="stat-item">
							<span>Réservations actives</span>
							<span class="stat-value">{{ data.stats.reservations_actives }}</span>
						</li>
					</ul>
				</div>
				<div class="widget-footer">
					<a href="{{ url_for('admin.admin') }}" class="btn-widget">Panel Admin</a>
				</div>
			</div>
			{% endif %}

        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='js/modules/tour.js') }}" type="module"></script>
    <script type="module">
        import { startTour } from "{{ url_for('static', filename='js/modules/tour.js') }}";
        {% if start_tour %}
            startTour();
        {% endif %}
    </script>
{% endblock %}