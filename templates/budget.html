{% extends "base.html" %}

{% block title %}Suivi Budgétaire - LabFlow{% endblock %}

{% block content %}

<div class="main-container">
    {% include '_breadcrumb.html' %}

    <!-- EN-TÊTE DE PAGE -->
    <div class="d-flex align-items-center gap-3 mb-4">
        <!-- Icône Euro Simple et Pro -->
        <div class="rounded-3 d-flex align-items-center justify-content-center text-white shadow-sm" 
             style="width: 48px; height: 48px; background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);">
            <i class="bi bi-currency-euro fs-3"></i>
        </div>
        <div>
            <h2 class="h3 mb-0 fw-bold text-dark">Suivi Budgétaire</h2>
            <p class="text-muted mb-0 small">Gérez vos crédits et dépenses pour l'année scolaire</p>
        </div>
    </div>

    <div class="row g-4">
        
        <!-- COLONNE GAUCHE : SYNTHÈSE & EXPORT -->
        <div class="col-lg-4">
            <div class="d-flex flex-column gap-4">
                
                <!-- 1. CARTE DE SYNTHÈSE -->
                <div class="budget-summary-card">
                    <div class="budget-header-premium">
                        <h4><i class="bi bi-pie-chart-fill me-2"></i> Synthèse {{ budget_affiche.annee if budget_affiche else '...' }}</h4>
                    </div>
                    
                    <div class="budget-body">
                        {% if budget_affiche %}
                            <ul class="budget-stat-list">
                                <li class="budget-stat-item">
                                    <span class="stat-label">Budget Initial</span>
                                    <span class="stat-value val-neutral">{{ "%.2f"|format(budget_affiche.montant_initial) }} €</span>
                                </li>
                                <li class="budget-stat-item">
                                    <span class="stat-label">Dépenses Totales</span>
                                    <span class="stat-value text-danger">- {{ "%.2f"|format(total_depenses) }} €</span>
                                </li>
                                <li class="budget-stat-item">
                                    <span class="stat-label fw-bold text-dark">Solde Restant</span>
                                    <span class="stat-value solde-highlight {{ 'negative' if solde < 0 else '' }}">
                                        {{ "%.2f"|format(solde) }} €
                                    </span>
                                </li>
                            </ul>

                            {% if session.user_role == 'admin' %}
                            <div class="budget-actions">
                                <button class="btn-budget-action btn-budget-edit" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#budgetModal"
                                        onclick="setupBudgetModal('{{ budget_affiche.annee }}', '{{ '%.2f'|format(budget_affiche.montant_initial) }}')">
                                    <i class="bi bi-pencil-square"></i> Modifier le Budget
                                </button>

                                {% if not budget_affiche.cloture %}
                                    <button class="btn-budget-action btn-budget-add" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#depenseModal"
                                            onclick="resetDepenseModal()">
                                        <i class="bi bi-plus-circle"></i> Ajouter une Dépense
                                    </button>
                                    
                                    {% if cloture_autorisee %}
                                    <button class="btn-budget-action btn-outline-secondary" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#modalCloture">
                                        <i class="bi bi-lock-fill"></i> Clôturer l'année
                                    </button>
                                    {% else %}
                                    <button class="btn-budget-action btn-budget-close" disabled title="Disponible dès juin">
                                        <i class="bi bi-lock"></i> Clôture (dès juin)
                                    </button>
                                    {% endif %}
                                {% else %}
                                    <div class="alert alert-warning text-center small mb-0 mt-2">
                                        <i class="bi bi-lock-fill"></i> Budget Clôturé
                                    </div>
                                {% endif %}
                            </div>
                            {% endif %}

                        {% else %}
                            <div class="text-center py-4">
                                <p class="text-muted mb-3">Aucun budget défini pour cette année.</p>
                                {% if session.user_role == 'admin' %}
                                <button class="btn-budget-action btn-budget-add" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#budgetModal">
                                    <i class="bi bi-plus-lg"></i> Définir le Budget
                                </button>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- 2. CARTE D'EXPORT (CORRIGÉE) -->
                <div class="export-card-premium">
                    <div class="export-card-header">
                        <h5 class="export-card-title"><i class="bi bi-download me-2"></i> Exporter les Dépenses</h5>
                    </div>
                    
                    <div class="export-zone-premium">
                        <div class="period-selector">
                            <label class="export-label">Période d'export</label>
                            <div class="date-input-wrapper">
                                <div class="date-input-group">
                                    <span class="date-prefix">Du</span>
                                    <input type="date" id="date_debut_export" class="date-input" 
                                           value="{{ (now.replace(month=9, day=1) if now.month >= 9 else now.replace(year=now.year-1, month=9, day=1)).strftime('%Y-%m-%d') }}">
                                </div>
                                <div class="date-separator"><i class="bi bi-arrow-right"></i></div>
                                <div class="date-input-group">
                                    <span class="date-prefix">Au</span>
                                    <input type="date" id="date_fin_export" class="date-input" 
                                           value="{{ now.strftime('%Y-%m-%d') }}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="export-actions">
                            <button type="button" onclick="exportData('pdf')" class="btn-export-file pdf">
                                <i class="bi bi-file-earmark-pdf-fill export-btn-icon"></i>
                                <span class="export-btn-title">PDF Imprimable</span>
                            </button>
                            
                            <button type="button" onclick="exportData('excel')" class="btn-export-file excel">
                                <i class="bi bi-file-earmark-excel-fill export-btn-icon"></i>
                                <span class="export-btn-title">Excel Tableau</span>
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- COLONNE DROITE : TABLEAU DES DÉPENSES -->
        <div class="col-lg-8">
            <div class="budget-table-card">
                <div class="budget-table-header">
                    <h5 class="mb-0 fw-bold text-dark">Détail des Dépenses</h5>
                    
                    <!-- Sélecteur d'année ALIGNÉ -->
                    {% if budgets_archives %}
                    <form action="{{ url_for('admin.budget') }}" method="get" class="year-selector-group">
                        <label for="annee_select" class="year-label">ANNÉE :</label>
                        <select name="annee" id="annee_select" class="budget-year-select" onchange="this.form.submit()">
                            {% for ba in budgets_archives %}
                                <option value="{{ ba.annee }}" {% if ba.annee == annee_selectionnee %}selected{% endif %}>
                                    {{ ba.annee | annee_scolaire }}
                                    {% if ba.cloture %}(Clôturé){% else %}(Actif){% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    </form>
                    {% endif %}
                </div>

                <div class="table-responsive">
                    <table class="budget-table">
                        <thead>
                            <tr>
                                <th style="width: 110px;">Date</th>
                                <th>Fournisseur / Libellé</th>
                                <th class="text-end" style="width: 120px;">Montant</th>
                                {% if session.user_role == 'admin' and budget_affiche and not budget_affiche.cloture %}
                                <th class="text-end" style="width: 100px;">Actions</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% if depenses %}
                                {% for depense in depenses %}
                                <tr>
                                    <td class="text-nowrap">{{ depense.date_depense.strftime('%d/%m/%Y') }}</td>
                                    <td>
                                        <div class="fw-bold text-dark">
                                            {% if depense.est_bon_achat %}
                                                <span class="badge bg-light text-dark border"><i class="bi bi-ticket-perforated me-1"></i>Bon d'achat</span>
                                            {% else %}
                                                <span class="text-primary">{{ depense.fournisseur.nom if depense.fournisseur else 'Inconnu' }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="small text-muted">{{ depense.contenu }}</div>
                                    </td>
                                    <td class="text-end amount-cell text-danger">
                                        - {{ "%.2f"|format(depense.montant) }} €
                                    </td>
                                    
                                    {% if session.user_role == 'admin' and not budget_affiche.cloture %}
                                    <td class="text-end">
                                        <div class="d-flex justify-content-end gap-1">
                                            <button class="btn btn-sm btn-outline-primary btn-icon-only edit-depense-btn"
                                                    onclick='openEditDepenseModal({{ depense.id }}, "{{ depense.date_depense }}", "{{ depense.fournisseur_id or "" }}", {{ "true" if depense.est_bon_achat else "false" }}, "{{ depense.contenu|replace('"', '&quot;')|replace("'", "&apos;") }}", "{{ depense.montant }}")'
                                                    title="Modifier">
                                                <i class="bi bi-pencil-fill"></i>
                                            </button>
                                            
                                            <button class="btn btn-sm btn-outline-danger btn-icon-only" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#deleteModal"
                                                    data-url="{{ url_for('admin.supprimer_depense', id=depense.id) }}"
                                                    title="Supprimer">
                                                <i class="bi bi-trash-fill"></i>
                                            </button>
                                        </div>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="4" class="text-center py-5 text-muted">
                                        <div class="mb-3">
                                            <i class="bi bi-receipt display-4 opacity-25"></i>
                                        </div>
                                        <h6 class="fw-bold">Aucune dépense</h6>
                                        <p class="small mb-0">Les dépenses enregistrées apparaîtront ici.</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODALES (Uniquement pour ADMIN) -->
{% if session.user_role == 'admin' %}
    <!-- Modale Budget -->
    <div class="modal fade" id="budgetModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-cash-coin me-2"></i>Budget Annuel</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form action="{{ url_for('admin.definir_budget') }}" method="post">
                    <div class="modal-body">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Année de début</label>
                            <input type="number" class="form-control" name="annee" id="budgetAnnee" required placeholder="ex: 2025">
                            <div class="form-text">Pour l'année scolaire 2025-2026, entrez 2025.</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Montant Initial (€)</label>
                            <input type="number" step="0.01" class="form-control" name="montant_initial" id="budgetMontant" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modale Dépense -->
    <div class="modal fade" id="depenseModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="depenseModalTitle"><i class="bi bi-cart-plus me-2"></i>Nouvelle Dépense</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="depenseForm" action="{{ url_for('admin.ajouter_depense') }}" method="post">
                    <div class="modal-body">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="budget_id" value="{{ budget_affiche.id if budget_affiche else '' }}">
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Date</label>
                            <input type="date" class="form-control" name="date_depense" id="depenseDate" required value="{{ now.strftime('%Y-%m-%d') }}" max="{{ now.strftime('%Y-%m-%d') }}">
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch mb-2 p-2 border rounded bg-light">
                                <input class="form-check-input ms-0 me-2" type="checkbox" name="est_bon_achat" id="checkBonAchat" onchange="toggleFournisseur()">
                                <label class="form-check-label fw-bold" for="checkBonAchat">C'est un Bon d'achat (Petit matériel)</label>
                            </div>
                            
                            <div id="divFournisseur">
                                <label class="form-label fw-bold">Fournisseur</label>
                                <select class="form-select" name="fournisseur_id" id="selectFournisseur">
                                    <option value="">-- Choisir --</option>
                                    {% for f in fournisseurs %}
                                        <option value="{{ f.id }}">{{ f.nom }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Libellé / Contenu</label>
                            <textarea class="form-control" name="contenu" id="depenseContenu" rows="2" required placeholder="Ex: Achat verrerie TP Chimie"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Montant (€)</label>
                            <input type="number" step="0.01" class="form-control" name="montant" id="depenseMontant" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-success">Valider</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modale Suppression -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fw-bold"><i class="bi bi-trash3-fill me-2"></i>Supprimer la dépense</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="mb-0 fs-5">Voulez-vous vraiment supprimer cette dépense ?</p>
                    <p class="text-muted small mt-2 mb-0">Le montant sera recrédité au budget.</p>
                </div>
                <div class="modal-footer bg-light border-0">
                    <button type="button" class="btn btn-light fw-bold text-muted" data-bs-dismiss="modal">Annuler</button>
                    <form id="deleteForm" method="post" action="">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-danger px-4 fw-bold">Confirmer la suppression</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modale Clôture -->
    {% if budget_affiche %}
    <div class="modal fade" id="modalCloture" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fw-bold"><i class="bi bi-lock-fill me-2"></i>Clôture du Budget</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="fw-bold text-dark mb-2">Êtes-vous sûr de vouloir clôturer l'année {{ budget_affiche.annee }}-{{ budget_affiche.annee + 1 }} ?</p>
                    <div class="alert alert-warning d-flex align-items-start gap-2 mb-0">
                        <i class="bi bi-exclamation-triangle-fill mt-1 flex-shrink-0"></i>
                        <div class="small">
                            Cette action est <strong>irréversible</strong>.<br>
                            Vous ne pourrez plus modifier ce budget.
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light border-0">
                    <button type="button" class="btn btn-light fw-bold" data-bs-dismiss="modal">Annuler</button>
                    <form action="{{ url_for('admin.cloturer_budget') }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="budget_id" value="{{ budget_affiche.id }}">
                        <button type="submit" class="btn btn-danger fw-bold">Confirmer la clôture</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

{% endif %}

{% endblock %}

{% block scripts %}
<script>
    // --- 1. GESTION DU POINT/VIRGULE (UX) ---
    document.addEventListener('DOMContentLoaded', function() {
        const numberInputs = document.querySelectorAll('input[type="number"]');
        numberInputs.forEach(input => {
            input.type = "text";
            input.inputMode = "decimal";
            input.addEventListener('keydown', function(e) {
                if (e.key === '.' || e.key === 'Decimal') {
                    e.preventDefault();
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    const val = this.value;
                    if (!val.includes(',')) {
                        this.value = val.substring(0, start) + ',' + val.substring(end);
                        this.setSelectionRange(start + 1, start + 1);
                    }
                }
            });
            input.addEventListener('input', function(e) {
                let val = this.value.replace(/[^0-9,]/g, '');
                const parts = val.split(',');
                if (parts.length > 2) val = parts[0] + ',' + parts.slice(1).join('');
                if (this.value !== val) this.value = val;
            });
        });

        // --- RESET MODALE BUDGET A LA FERMETURE ---
        const budgetModal = document.getElementById('budgetModal');
        if (budgetModal) {
            budgetModal.addEventListener('hidden.bs.modal', function () {
                const inputAnnee = document.getElementById('budgetAnnee');
                const form = budgetModal.querySelector('form');
                
                // On remet à zéro
                form.reset();
                
                // On déverrouille visuellement et techniquement
                inputAnnee.readOnly = false;
                inputAnnee.classList.remove('bg-secondary', 'bg-opacity-10'); // Enlève le gris
                inputAnnee.style.cursor = 'text'; // Remet le curseur texte
            });
        }
    });

    // --- 2. LOGIQUE MÉTIER ---
    
    // Bascule Fournisseur / Bon d'achat
    function toggleFournisseur() {
        const isBonAchat = document.getElementById('checkBonAchat').checked;
        const divFournisseur = document.getElementById('divFournisseur');
        const selectFournisseur = document.getElementById('selectFournisseur');
        
        if (isBonAchat) {
            divFournisseur.style.display = 'none';
            selectFournisseur.required = false;
            selectFournisseur.value = "";
        } else {
            divFournisseur.style.display = 'block';
            selectFournisseur.required = true;
        }
    }

    // Prépa Modale Budget (CORRIGÉ UX)
    function setupBudgetModal(annee, montant) {
        const inputAnnee = document.getElementById('budgetAnnee');
        
        inputAnnee.value = annee;
        document.getElementById('budgetMontant').value = montant;

        // FIX UX : Verrouillage visuel complet
        inputAnnee.readOnly = true;
        inputAnnee.classList.add('bg-secondary', 'bg-opacity-10'); // Fond gris moderne
        inputAnnee.style.cursor = 'not-allowed'; // Curseur sens interdit
    }

    // Reset Modale Dépense (Ajout)
    function resetDepenseModal() {
        document.getElementById('depenseModalTitle').innerHTML = '<i class="bi bi-cart-plus me-2"></i>Nouvelle Dépense';
        document.getElementById('depenseForm').action = "{{ url_for('admin.ajouter_depense') }}";
        document.getElementById('depenseDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('checkBonAchat').checked = false;
        document.getElementById('depenseContenu').value = '';
        document.getElementById('depenseMontant').value = '';
        toggleFournisseur();
        document.getElementById('selectFournisseur').value = "";
    }

    // Prépa Modale Dépense (Modif)
    function openEditDepenseModal(id, date, fournisseurId, isBonAchat, contenu, montant) {
        const modal = new bootstrap.Modal(document.getElementById('depenseModal'));
        modal.show();

        document.getElementById('depenseModalTitle').innerHTML = '<i class="bi bi-pencil-square me-2"></i>Modifier la Dépense';
        document.getElementById('depenseForm').action = "/admin/budget/depense/modifier/" + id;
        
        // Formatage date YYYY-MM-DD
        let dateStr = date;
        if(date.includes(' ')) dateStr = date.split(' ')[0];
        document.getElementById('depenseDate').value = dateStr;
        
        document.getElementById('checkBonAchat').checked = isBonAchat;
        document.getElementById('depenseContenu').value = contenu;
        document.getElementById('depenseMontant').value = montant;
        
        toggleFournisseur();
        
        if (!isBonAchat) {
            document.getElementById('selectFournisseur').value = fournisseurId;
        }
    }

    // Suppression
    const deleteModal = document.getElementById('deleteModal');
    if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const url = button.dataset.url;
            document.getElementById('deleteForm').action = url;
        });
    }

    // Export
    function exportData(format) {
        const dateDebut = document.getElementById('date_debut_export').value;
        const dateFin = document.getElementById('date_fin_export').value;
        
        if (!dateDebut || !dateFin) {
            alert("Veuillez sélectionner une date de début et une date de fin.");
            return;
        }
        if (dateDebut > dateFin) {
            alert("La date de début ne peut pas être postérieure à la date de fin.");
            return;
        }

        const url = `/admin/budget/exporter?format=${format}&date_debut=${dateDebut}&date_fin=${dateFin}`;
        window.location.href = url;
    }
</script>
{% endblock %}