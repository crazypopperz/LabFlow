{% extends "base.html" %}

{% block title %}Mon Profil - LabFlow{% endblock %}

{% block content %}
<div class="main-container d-flex align-items-center justify-content-center" style="min-height: 80vh;">
    
    <div class="card border-0 shadow-lg" style="width: 100%; max-width: 500px; border-radius: 16px;">
        <div class="card-body p-5">
            
            <!-- En-tête du Profil -->
            <div class="text-center mb-4">
                <div class="d-inline-flex align-items-center justify-content-center bg-primary-subtle text-primary rounded-circle mb-3" style="width: 80px; height: 80px;">
                    <i class="bi bi-person-fill display-4"></i>
                </div>
                <h2 class="h4 fw-bold text-dark mb-1">Mon Profil</h2>
                <p class="text-muted small">
                    Connecté en tant que <strong>{{ session.username or 'Utilisateur' }}</strong>
                </p>
            </div>

            <!-- Formulaire -->
            <form method="POST" action="{{ url_for('auth.profil') }}" id="profileForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <!-- Ancien Mot de passe -->
                <div class="form-floating mb-3 position-relative">
                    <!-- CORRECTION NAME -->
                    <input type="password" class="form-control" id="ancien_mot_de_passe" name="ancien_mot_de_passe" placeholder="Mot de passe actuel" required>
                    <label for="ancien_mot_de_passe">Mot de passe actuel</label>
                    <button type="button" class="btn btn-link position-absolute top-50 end-0 translate-middle-y text-muted pe-3 text-decoration-none" onclick="togglePassword('ancien_mot_de_passe', this)">
                        <i class="bi bi-eye"></i>
                    </button>
                </div>

                <hr class="my-4 opacity-10">

                <!-- Nouveau Mot de passe -->
                <div class="form-floating mb-2 position-relative">
                    <!-- CORRECTION NAME -->
                    <input type="password" class="form-control" id="nouveau_mot_de_passe" name="nouveau_mot_de_passe" placeholder="Nouveau mot de passe" required minlength="12">
                    <label for="nouveau_mot_de_passe">Nouveau mot de passe</label>
                    <button type="button" class="btn btn-link position-absolute top-50 end-0 translate-middle-y text-muted pe-3 text-decoration-none" onclick="togglePassword('nouveau_mot_de_passe', this)">
                        <i class="bi bi-eye"></i>
                    </button>
                </div>

                <!-- Barre de force -->
                <div class="progress mb-3" style="height: 4px;">
                    <div class="progress-bar bg-danger" id="strengthBar" role="progressbar" style="width: 0%"></div>
                </div>

                <!-- Confirmation -->
                <div class="form-floating mb-4 position-relative">
                    <!-- CORRECTION NAME -->
                    <input type="password" class="form-control" id="confirmation_mot_de_passe" name="confirmation_mot_de_passe" placeholder="Confirmer le nouveau" required>
                    <label for="confirmation_mot_de_passe">Confirmer le nouveau mot de passe</label>
                    <div class="invalid-feedback">Les mots de passe ne correspondent pas.</div>
                </div>

                <!-- Actions -->
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary py-2 fw-bold" id="btnSave">
                        Mettre à jour le mot de passe
                    </button>
                    <a href="{{ url_for('inventaire.index') }}" class="btn btn-light text-muted">
                        Annuler
                    </a>
                </div>

            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Fonction pour afficher/masquer le mot de passe
    function togglePassword(inputId, btn) {
        const input = document.getElementById(inputId);
        const icon = btn.querySelector('i');
        
        if (input.type === "password") {
            input.type = "text";
            icon.classList.remove('bi-eye');
            icon.classList.add('bi-eye-slash');
        } else {
            input.type = "password";
            icon.classList.remove('bi-eye-slash');
            icon.classList.add('bi-eye');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const newPass = document.getElementById('nouveau_mot_de_passe');
        const confirmPass = document.getElementById('confirmation_mot_de_passe');
        const strengthBar = document.getElementById('strengthBar');
        const form = document.getElementById('profileForm');
        const btnSave = document.getElementById('btnSave');

        // Calcul simple de la force
        newPass.addEventListener('input', function() {
            const val = newPass.value;
            let strength = 0;
            if (val.length >= 8) strength += 25;
            if (val.length >= 12) strength += 25;
            if (/[A-Z]/.test(val)) strength += 25;
            if (/[0-9]/.test(val)) strength += 25;

            strengthBar.style.width = strength + '%';
            
            if (strength < 50) strengthBar.className = 'progress-bar bg-danger';
            else if (strength < 75) strengthBar.className = 'progress-bar bg-warning';
            else strengthBar.className = 'progress-bar bg-success';
        });

        // Validation correspondance
        form.addEventListener('submit', function(e) {
            if (newPass.value !== confirmPass.value) {
                e.preventDefault();
                confirmPass.classList.add('is-invalid');
            } else {
                confirmPass.classList.remove('is-invalid');
                // UI Loading
                btnSave.disabled = true;
                btnSave.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Mise à jour...';
            }
        });

        confirmPass.addEventListener('input', function() {
            if (confirmPass.value === newPass.value) {
                confirmPass.classList.remove('is-invalid');
                confirmPass.classList.add('is-valid');
            } else {
                confirmPass.classList.remove('is-valid');
                if(confirmPass.value.length > 0) confirmPass.classList.add('is-invalid');
            }
        });
    });
</script>

<!-- Petit style spécifique pour nettoyer les inputs -->
<style>
    .form-floating > .form-control {
        border: 1px solid #dee2e6;
        background-color: #f8f9fa;
    }
    .form-floating > .form-control:focus {
        background-color: #fff;
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.1);
    }
</style>
{% endblock %}